<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RedMessenger PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff2e2e;
            --primary-dark: #d40000;
            --primary-light: #ff6b6b;
            --secondary: #000000;
            --bg-color: #0a0a0a;
            --sidebar-bg: #111111;
            --card-bg: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: #333333;
            --online: #00ff00;
            --offline: #ff2e2e;
            --message-out: #ff2e2e;
            --message-in: #333333;
            --unread: #ff2e2e;
            --hover-bg: #222222;
            --shadow: 0 2px 10px rgba(255, 46, 46, 0.1);
            --shadow-lg: 0 5px 20px rgba(255, 46, 46, 0.2);
            --gradient: linear-gradient(135deg, #ff2e2e 0%, #000000 100%);
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff2e2e;
            --like-color: #ff4757;
            --dislike-color: #747d8c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--gradient);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
        }

        .auth-box {
            background: var(--card-bg);
            padding: 30px 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.5s ease;
            overflow-y: auto;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            min-height: 44px;
        }

        .auth-tab.active {
            color: var(--text-primary);
            background: var(--primary);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px 15px;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
            min-height: 44px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 14px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: black;
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        .btn-sm {
            padding: 10px 15px;
            font-size: 14px;
            min-height: 36px;
        }

        .hidden {
            display: none !important;
        }

        .emoji-avatar {
            font-size: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            border: 3px solid var(--primary);
        }

        .emoji-avatar.small {
            width: 45px;
            height: 45px;
            font-size: 18px;
            border-width: 2px;
        }

        .emoji-avatar.large {
            width: 80px;
            height: 80px;
            font-size: 32px;
        }

        .scrollable {
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }

        .scrollable::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 4px;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .scrollable::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .app-container {
            display: none;
            height: 100vh;
            background: var(--bg-color);
            flex-direction: column;
        }

        .app-container.active {
            display: flex;
        }

        /* Mobile Navigation */
        .mobile-header {
            display: none;
            padding: 15px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            justify-content: space-between;
            align-items: center;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        .sidebar {
            width: 100%;
            max-width: 380px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px 15px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-menu {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            background: var(--card-bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            user-select: none;
            min-height: 80px;
        }

        .menu-item:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .menu-item.active {
            background: var(--primary);
            color: white;
        }

        .menu-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .menu-label {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--card-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            user-select: none;
            min-height: 70px;
        }

        .chat-item:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .chat-item.unread {
            border-color: var(--primary);
        }

        .chat-item-avatar {
            position: relative;
            flex-shrink: 0;
        }

        .online-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--online);
            border-radius: 50%;
            border: 2px solid var(--sidebar-bg);
        }

        .offline-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--offline);
            border-radius: 50%;
            border: 2px solid var(--sidebar-bg);
        }

        .chat-info {
            flex: 1;
            margin-left: 15px;
            min-width: 0;
            overflow: hidden;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-left: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .unread-badge {
            background: var(--primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            margin-top: 5px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            position: relative;
            min-width: 0;
            height: 100vh;
            overflow: hidden;
        }

        .chat-header-bar {
            padding: 15px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-contact {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 0;
            flex: 1;
        }

        .chat-contact-info {
            flex: 1;
            min-width: 0;
        }

        .chat-contact-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-contact-username {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-action {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-color);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .chat-action:hover {
            background: var(--primary);
            color: white;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
            flex-shrink: 0;
            position: relative;
        }

        .message.incoming {
            align-self: flex-start;
        }

        .message.outgoing {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 14px;
            box-shadow: var(--shadow);
            max-width: 100%;
            overflow-wrap: break-word;
            word-break: break-word;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .message-bubble:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .message.incoming .message-bubble {
            background: var(--message-in);
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 18px;
        }

        .message.outgoing .message-bubble {
            background: var(--message-out);
            color: white;
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 18px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
        }

        .message-input-container {
            padding: 15px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            gap: 10px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .message-input-wrapper {
            flex: 1;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 50px;
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            padding: 4px 0;
            line-height: 1.5;
            font-family: inherit;
            overflow-y: hidden;
        }

        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
        }

        /* –°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç–æ–≤ */
        .posts-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            overflow: hidden;
        }

        .posts-header {
            padding: 15px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .posts-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
            padding: 15px;
        }

        .post-card {
            background: var(--card-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        .post-header {
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .post-author-info {
            flex: 1;
            min-width: 0;
        }

        .post-author-name {
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-author-username {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-time {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-left: 10px;
        }

        .post-content {
            padding: 15px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
        }

        .post-stats {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .post-actions {
            padding: 0 15px 15px;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .post-action-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .post-action-btn.liked {
            color: var(--like-color);
        }

        .post-action-btn.disliked {
            color: var(--dislike-color);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-screen {
            padding: 15px;
            overflow-y: auto;
        }

        .settings-group {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-info {
            flex: 1;
            margin-right: 15px;
        }

        .settings-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 15px;
        }

        .settings-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* –ü–æ–ª–∑—É–Ω–∫–∏ */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 200px;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid var(--bg-color);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid var(--bg-color);
        }

        /* –ü–æ–∏—Å–∫ */
        .search-screen {
            padding: 15px;
            overflow-y: auto;
        }

        .search-input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-input {
            width: 100%;
            padding: 15px 15px 15px 50px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            min-height: 50px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .user-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .user-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .username-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 46, 46, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--primary);
            border: 1px solid rgba(255, 46, 46, 0.3);
            white-space: nowrap;
        }

        .role-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .role-badge.admin {
            background: #9d00ff;
            color: white;
        }

        .role-badge.verified {
            background: linear-gradient(135deg, #00b4ff, #0088ff);
            color: white;
        }

        .no-content {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-content-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* –ê–¥–º–∏–Ω —Å—Ç–∏–ª–∏ */
        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--primary);
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .admin-action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            min-height: 80px;
        }

        .admin-action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .admin-action-icon {
            font-size: 24px;
        }

        .admin-action-label {
            font-size: 12px;
            text-align: center;
        }

        /* –¢–µ–ª–µ–≥—Ä–∞–º-–ø–æ–¥–æ–±–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message-date-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .message-date-divider span {
            background: var(--card-bg);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            display: inline-block;
        }

        .message-status {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            margin-left: 5px;
        }

        .message-status .sent { color: var(--text-secondary); }
        .message-status .read { color: #34b7f1; }

        /* –ú–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–∞–∫ –≤ Telegram) */
        .message-menu {
            position: absolute;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 100;
            min-width: 180px;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .message-menu.active {
            display: flex;
        }

        .message-menu-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }

        .message-menu-item:last-child {
            border-bottom: none;
        }

        .message-menu-item:hover {
            background: var(--hover-bg);
        }

        .message-menu-item.delete {
            color: var(--danger);
        }

        .message-menu-item.delete:hover {
            background: rgba(255, 46, 46, 0.1);
        }

        .message-menu-item-icon {
            width: 20px;
            text-align: center;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ */
        .editable-field {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .editable-field:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
        }

        .editable-field.editing {
            background: var(--bg-color);
            border-color: var(--primary);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 20px;
            height: 20px;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid white;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* –¢–µ–º–∏–∑–∞—Ü–∏—è */
        .theme-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.active {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        /* –í—ã—Ö–æ–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .logout-settings-btn {
            width: 100%;
            margin-top: 20px;
        }

        /* Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            
            .mobile-header {
                display: none;
            }
            
            .sidebar {
                position: relative;
                transform: none;
                width: 380px;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            .menu-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .search-results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .message {
                max-width: 70%;
            }
        }

        @media (min-width: 992px) {
            .admin-actions {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .search-results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .admin-stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 767px) {
            .auth-box {
                padding: 20px 15px;
            }
            
            .settings-screen,
            .search-screen {
                padding: 10px;
            }
            
            .menu-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .message {
                max-width: 90%;
            }
            
            .admin-actions {
                grid-template-columns: 1fr;
            }
            
            .admin-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                max-width: 95%;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .sidebar {
                width: 85%;
                max-width: 320px;
            }
        }

        @media (max-width: 480px) {
            .auth-box {
                padding: 15px;
            }
            
            .auth-tab {
                font-size: 14px;
                padding: 10px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .message {
                max-width: 95%;
            }
            
            .chat-actions {
                gap: 5px;
            }
            
            .chat-action {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            .modal-body,
            .modal-header,
            .modal-footer {
                padding: 15px;
            }
        }

        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        .fixed-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç */
        .text-gradient {
            background: linear-gradient(45deg, #ff2e2e, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div class="auth-container" id="auth-container">
        <div class="auth-box scrollable">
            <h1 class="auth-title" style="text-align: center; margin-bottom: 25px; font-size: 28px; background: linear-gradient(45deg, #ff2e2e, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">RedMessenger PRO</h1>
            
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">–í—Ö–æ–¥</button>
                <button class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div id="login-form">
                <div class="form-group">
                    <label class="form-label">–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                    <input type="text" class="form-input" id="login-username" placeholder="@username –∏–ª–∏ –ª–æ–≥–∏–Ω" value="@admin">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="login-password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" value="admin123">
                    <div style="text-align: right; margin-top: 5px;">
                        <button type="button" id="show-password" style="background: none; border: none; color: var(--text-secondary); font-size: 12px; cursor: pointer; padding: 5px;">
                            <i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="login-btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                </button>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="register-form" class="hidden">
                <div class="form-group">
                    <label class="form-label">–ò–º—è</label>
                    <input type="text" class="form-input" id="reg-firstname" placeholder="–í–∞—à–µ –∏–º—è">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" class="form-input" id="reg-lastname" placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--text-secondary);">@</span>
                        <input type="text" class="form-input" id="reg-username" placeholder="username" style="flex: 1;">
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                        –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="reg-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                    <input type="password" class="form-input" id="reg-password-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–≠–º–æ–¥–∑–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="emoji-avatar small" id="reg-emoji-preview">üë§</div>
                        <input type="text" class="form-input" id="reg-emoji" placeholder="üéÆ" value="üë§" maxlength="2">
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 14px;">
                        <input type="checkbox" id="reg-terms" style="margin-top: 3px; width: 18px; height: 18px;">
                        <span style="color: var(--text-secondary);">
                            –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                        </span>
                    </label>
                </div>
                
                <button class="btn btn-success" id="register-btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <p style="color: var(--text-secondary); font-size: 14px;">
                    –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç –∞–¥–º–∏–Ω–∞: <strong>@admin / admin123</strong><br>
                    –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>@alex / alex123</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app-container" id="app-container">
        <!-- Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä -->
        <div class="mobile-header">
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            <div style="font-weight: 600; font-size: 18px;" id="mobile-title">RedMessenger</div>
            <div style="width: 40px;"></div>
        </div>

        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile" id="user-profile">
                    <div class="emoji-avatar small" id="user-avatar">
                        <span id="avatar-text">üë§</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name">
                            <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                            <span class="role-badge admin" id="user-role" style="display: none;">ADMIN</span>
                        </div>
                        <div class="user-username" id="user-username">@username</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; background: var(--online); border-radius: 50%; margin-right: 5px;"></span> 
                            <span id="user-status">online</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-grid">
                    <div class="menu-item active" data-menu="chats">
                        <i class="fas fa-comments menu-icon"></i>
                        <span class="menu-label">–ß–∞—Ç—ã</span>
                    </div>
                    <div class="menu-item" data-menu="posts">
                        <i class="fas fa-images menu-icon"></i>
                        <span class="menu-label">–ü–æ—Å—Ç—ã</span>
                    </div>
                    <div class="menu-item" data-menu="search">
                        <i class="fas fa-search menu-icon"></i>
                        <span class="menu-label">–ü–æ–∏—Å–∫</span>
                    </div>
                    <div class="menu-item" data-menu="settings">
                        <i class="fas fa-cog menu-icon"></i>
                        <span class="menu-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </div>
                    <div class="menu-item" data-menu="admin" id="admin-menu-item" style="display: none;">
                        <i class="fas fa-crown menu-icon"></i>
                        <span class="menu-label">–ê–¥–º–∏–Ω</span>
                    </div>
                </div>
            </div>

            <div class="chats-list scrollable" id="chats-list">
                <!-- –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content" id="main-content">
            <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–æ–≤ -->
            <div class="messages-container scrollable hidden" id="chats-screen">
                <div class="no-content" id="no-chat-selected">
                    <i class="fas fa-comments no-content-icon"></i>
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –ª—é–±—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</p>
                </div>
                
                <!-- –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                <div class="hidden" id="active-chat-container">
                    <div class="chat-header-bar" id="chat-header">
                        <button class="mobile-menu-btn" id="back-to-chats-btn" style="display: none;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="chat-contact">
                            <div class="emoji-avatar small" id="chat-contact-avatar">
                                <span id="contact-avatar-text">üë§</span>
                            </div>
                            <div class="chat-contact-info">
                                <div class="chat-contact-name">
                                    <span id="contact-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                                    <span class="username-badge" id="contact-username-badge">@username</span>
                                </div>
                                <div class="chat-contact-username" id="contact-username">
                                    <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; background: var(--online); border-radius: 50%; margin-right: 5px;"></span>
                                    <span id="contact-status-text">online</span>
                                </div>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action" id="delete-chat-btn" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="chat-action" id="user-profile-btn" title="–ü—Ä–æ—Ñ–∏–ª—å">
                                <i class="fas fa-user"></i>
                            </button>
                        </div>
                    </div>

                    <div class="messages-container scrollable" id="messages-container">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <div class="message-input-container">
                        <div class="message-input-wrapper">
                            <textarea class="message-input" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                            <button class="send-button" id="send-button">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –ø–æ—Å—Ç–æ–≤ -->
            <div class="posts-screen hidden" id="posts-screen">
                <div class="posts-header">
                    <h3 style="font-weight: 600; color: var(--primary);">
                        <i class="fas fa-images"></i> –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="refresh-posts-btn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="posts-container scrollable" id="posts-container">
                    <!-- –ü–æ—Å—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –ø–æ–∏—Å–∫–∞ -->
            <div class="search-screen scrollable hidden" id="search-screen">
                <h2 class="text-gradient" style="margin-bottom: 25px; font-size: 24px;">
                    <i class="fas fa-search"></i> –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </h2>
                
                <div class="search-input-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="search-users-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º...">
                </div>
                
                <div class="search-results-grid" id="search-results">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <div class="settings-screen scrollable hidden" id="settings-screen">
                <h2 class="text-gradient" style="margin-bottom: 25px; font-size: 24px;">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
                </h2>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-user"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                    </h3>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–≠–º–æ–¥–∑–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏</div>
                            <div class="settings-description">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è</div>
                        </div>
                        <div class="emoji-avatar small editable-field" id="edit-emoji-field" style="cursor: pointer;">
                            <span id="current-emoji">üë§</span>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ò–º—è</div>
                            <div class="settings-description">–í–∞—à–µ –∏–º—è</div>
                        </div>
                        <input type="text" class="form-input" id="edit-firstname" style="width: 100%; max-width: 200px;" placeholder="–ò–º—è">
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–§–∞–º–∏–ª–∏—è</div>
                            <div class="settings-description">–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è</div>
                        </div>
                        <input type="text" class="form-input" id="edit-lastname" style="width: 100%; max-width: 200px;" placeholder="–§–∞–º–∏–ª–∏—è">
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</div>
                            <div class="settings-description">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ</div>
                        </div>
                        <textarea class="form-input" id="edit-bio" style="width: 100%; max-width: 200px; height: 80px; resize: vertical;" placeholder="–û —Å–µ–±–µ..."></textarea>
                    </div>
                    
                    <div class="settings-item">
                        <div style="flex: 1;"></div>
                        <button class="btn btn-primary" id="save-profile-btn">
                            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                        </button>
                    </div>
                    
                    <button class="btn btn-primary" id="create-post-settings-btn" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç
                    </button>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-comments"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∞–º–∏
                    </h3>
                    
                    <div id="chat-management-list">
                        <!-- –°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-user-shield"></i> –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                    </h3>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>
                            <div class="settings-description">–°–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="private-profile-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å</div>
                            <div class="settings-description">–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç, –∫–æ–≥–¥–∞ –≤—ã –æ–Ω–ª–∞–π–Ω</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-status-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–†–∞–∑—Ä–µ—à–∏—Ç—å –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                            <div class="settings-description">–ö—Ç–æ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                        </div>
                        <select class="form-input" id="message-permissions" style="width: 100%; max-width: 200px;">
                            <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                            <option value="nobody">–ù–∏–∫—Ç–æ</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-paint-brush"></i> –í–Ω–µ—à–Ω–∏–π –≤–∏–¥
                    </h3>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
                            <div class="settings-description">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–≤—É—é —Ç–µ–º—É</div>
                        </div>
                        <div class="theme-selector" id="theme-selector">
                            <div class="theme-option" data-theme="dark" style="background: #0a0a0a;" title="–¢–µ–º–Ω–∞—è"></div>
                            <div class="theme-option" data-theme="light" style="background: #f5f5f5;" title="–°–≤–µ—Ç–ª–∞—è"></div>
                            <div class="theme-option" data-theme="red" style="background: #2a0a0a;" title="–ö—Ä–∞—Å–Ω–∞—è"></div>
                            <div class="theme-option" data-theme="blue" style="background: #0a0a2a;" title="–°–∏–Ω—è—è"></div>
                            <div class="theme-option" data-theme="green" style="background: #0a2a0a;" title="–ó–µ–ª–µ–Ω–∞—è"></div>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</div>
                            <div class="settings-description">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</div>
                        </div>
                        <div class="slider-container">
                            <span style="color: var(--text-secondary);">A</span>
                            <input type="range" min="12" max="20" value="14" class="slider" id="font-size-slider">
                            <span style="color: var(--text-secondary);">A</span>
                            <span class="slider-value" id="font-size-value">14px</span>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
                            <div class="settings-description">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏</div>
                        </div>
                        <div class="slider-container">
                            <span style="color: var(--text-secondary);">‚§¢</span>
                            <input type="range" min="1" max="5" value="3" class="slider" id="density-slider">
                            <span style="color: var(--text-secondary);">‚§¢</span>
                            <span class="slider-value" id="density-value">3</span>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>
                            <div class="settings-description">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –æ–∫–æ–Ω</div>
                        </div>
                        <div class="slider-container">
                            <span style="color: var(--text-secondary);">‚óê</span>
                            <input type="range" min="10" max="100" value="100" class="slider" id="opacity-slider">
                            <span style="color: var(--text-secondary);">‚óê</span>
                            <span class="slider-value" id="opacity-value">100%</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-bell"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </h3>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ</div>
                            <div class="settings-description">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="site-notifications-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                            <div class="settings-description">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                                <input type="checkbox" id="notification-messages" checked style="width: 18px; height: 18px;">
                                <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                                <input type="checkbox" id="notification-posts" style="width: 18px; height: 18px;">
                                <span>–ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                                <input type="checkbox" id="notification-system" checked style="width: 18px; height: 18px;">
                                <span>–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                            <div class="settings-description">–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–æ–≤—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–ì—Ä–æ–º–∫–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                            <div class="settings-description">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞</div>
                        </div>
                        <div class="slider-container">
                            <span style="color: var(--text-secondary);">üîà</span>
                            <input type="range" min="0" max="100" value="50" class="slider" id="volume-slider">
                            <span style="color: var(--text-secondary);">üîä</span>
                            <span class="slider-value" id="volume-value">50%</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle"></i> –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞
                    </h3>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã</div>
                            <div class="settings-description">–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –≤–∞—à–∏—Ö —á–∞—Ç–æ–≤</div>
                        </div>
                        <button class="btn btn-danger btn-sm" id="delete-all-chats-btn">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-title">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div>
                            <div class="settings-description">–ù–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</div>
                        </div>
                        <button class="btn btn-danger btn-sm" id="delete-account-btn">
                            <i class="fas fa-user-slash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                    
                    <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –í–´–•–û–î–ê -->
                    <div class="settings-item" style="border-top: 2px solid var(--danger); margin-top: 20px; padding-top: 20px;">
                        <div class="settings-info">
                            <div class="settings-title">–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                            <div class="settings-description">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–µ–∞–Ω—Å —Ä–∞–±–æ—Ç—ã</div>
                        </div>
                        <button class="btn btn-danger" id="logout-settings-btn" style="width: 120px;">
                            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
            <div class="settings-screen scrollable hidden" id="admin-screen">
                <h2 class="text-gradient" style="margin-bottom: 25px; font-size: 24px;">
                    <i class="fas fa-crown"></i> –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                </h2>
                
                <div class="admin-stats-grid">
                    <div class="admin-stat-card">
                        <div style="font-size: 28px; font-weight: bold; color: var(--primary);" id="admin-total-users">0</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="admin-stat-card">
                        <div style="font-size: 28px; font-weight: bold; color: var(--success);" id="admin-online-users">0</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
                    </div>
                    <div class="admin-stat-card">
                        <div style="font-size: 28px; font-weight: bold; color: var(--warning);" id="admin-total-posts">0</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</div>
                    </div>
                    <div class="admin-stat-card">
                        <div style="font-size: 28px; font-weight: bold; color: #00b4ff;" id="admin-total-messages">0</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-users-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                    </h3>
                    
                    <div class="admin-actions">
                        <button class="admin-action-btn" id="admin-view-all-users">
                            <i class="fas fa-users admin-action-icon"></i>
                            <span class="admin-action-label">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                        </button>
                        <button class="admin-action-btn" id="admin-create-user">
                            <i class="fas fa-user-plus admin-action-icon"></i>
                            <span class="admin-action-label">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                        </button>
                        <button class="admin-action-btn" id="admin-edit-user">
                            <i class="fas fa-user-edit admin-action-icon"></i>
                            <span class="admin-action-label">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                        </button>
                        <button class="admin-action-btn" id="admin-ban-user">
                            <i class="fas fa-ban admin-action-icon"></i>
                            <span class="admin-action-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button class="admin-action-btn" id="admin-unban-user">
                            <i class="fas fa-check admin-action-icon"></i>
                            <span class="admin-action-label">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button class="admin-action-btn" id="admin-delete-user">
                            <i class="fas fa-trash admin-action-icon"></i>
                            <span class="admin-action-label">–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                        <button class="admin-action-btn" id="admin-grant-admin">
                            <i class="fas fa-user-shield admin-action-icon"></i>
                            <span class="admin-action-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º</span>
                        </button>
                        <button class="admin-action-btn" id="admin-revoke-admin">
                            <i class="fas fa-user-slash admin-action-icon"></i>
                            <span class="admin-action-label">–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞</span>
                        </button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-images"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏
                    </h3>
                    
                    <div class="admin-actions">
                        <button class="admin-action-btn" id="admin-view-all-posts">
                            <i class="fas fa-list admin-action-icon"></i>
                            <span class="admin-action-label">–í—Å–µ –ø–æ—Å—Ç—ã</span>
                        </button>
                        <button class="admin-action-btn" id="admin-edit-post">
                            <i class="fas fa-edit admin-action-icon"></i>
                            <span class="admin-action-label">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</span>
                        </button>
                        <button class="admin-action-btn" id="admin-delete-post">
                            <i class="fas fa-trash admin-action-icon"></i>
                            <span class="admin-action-label">–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç</span>
                        </button>
                        <button class="admin-action-btn" id="admin-clear-posts">
                            <i class="fas fa-broom admin-action-icon"></i>
                            <span class="admin-action-label">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã</span>
                        </button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-database"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
                    </h3>
                    
                    <div class="admin-actions">
                        <button class="admin-action-btn" id="admin-backup">
                            <i class="fas fa-download admin-action-icon"></i>
                            <span class="admin-action-label">–ë—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö</span>
                        </button>
                        <button class="admin-action-btn" id="admin-export-data">
                            <i class="fas fa-file-export admin-action-icon"></i>
                            <span class="admin-action-label">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</span>
                        </button>
                        <button class="admin-action-btn" id="admin-clear-all-data">
                            <i class="fas fa-skull-crossbones admin-action-icon"></i>
                            <span class="admin-action-label">–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï</span>
                        </button>
                    </div>
                </div>
                
                <div id="admin-content">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–¥–º–∏–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–∫—Ä—ã—Ç–æ–µ) -->
    <div class="message-menu" id="message-menu">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–µ–Ω—é –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification-container" id="notification-container"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal scrollable" id="modal">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <script>
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
      })
      .catch(err => {
        console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', err);
      });
  });
}
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
        const SUPABASE_URL = 'https://apduujppytsfqiwdzcxo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwZHV1anBweXRzZnFpd2R6Y3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODg1NDEsImV4cCI6MjA4Mjk2NDU0MX0.Hv9euYKZwbSc_1d7NT7nmJFkPBogOrx8A90U2OjwILc';
        
        // ========== –ö–õ–ê–°–° –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê –° SUPABASE ==========
        class RedMessengerPRO {
            constructor() {
                this.currentUser = null;
                this.currentChat = null;
                this.currentMenu = 'chats';
                this.heartbeatInterval = null;
                this.messagePollingInterval = null;
                this.isSendingMessage = false;
                this.isLoading = false;
                this.activeOperations = new Set();
                this.debounceTimers = {};
                this.userStatuses = new Map();
                this.blockOperationInProgress = false;
                this.notificationSettings = {
                    site: true,
                    messages: true,
                    posts: false,
                    system: true,
                    sound: true,
                    volume: 50
                };
                this.lastMessageCheck = Date.now();
                this.lastSendTime = 0;
                this.selectedMessageForAction = null;
                this.setupGlobalEventListeners();
            }
            
            // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
            
            setupGlobalEventListeners() {
                console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π');
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', (e) => {
                    const messageMenu = document.getElementById('message-menu');
                    if (messageMenu && !messageMenu.contains(e.target) && !e.target.closest('.message-bubble')) {
                        messageMenu.classList.remove('active');
                        this.selectedMessageForAction = null;
                    }
                });
                
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                document.addEventListener('click', (e) => {
                    // –¢–∞–±—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    if (e.target.closest('.auth-tab')) {
                        const tab = e.target.closest('.auth-tab');
                        const tabName = tab.dataset.tab;
                        
                        document.querySelectorAll('.auth-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        tab.classList.add('active');
                        
                        const loginForm = document.getElementById('login-form');
                        const registerForm = document.getElementById('register-form');
                        
                        if (loginForm) loginForm.classList.toggle('hidden', tabName !== 'login');
                        if (registerForm) registerForm.classList.toggle('hidden', tabName !== 'register');
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–∞—Ä–æ–ª—è
                    if (e.target.closest('#show-password')) {
                        const passwordInput = document.getElementById('login-password');
                        const button = e.target.closest('#show-password');
                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            button.innerHTML = '<i class="fas fa-eye-slash"></i> –°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å';
                        } else {
                            passwordInput.type = 'password';
                            button.innerHTML = '<i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å';
                        }
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
                    if (e.target.closest('#login-btn')) {
                        this.handleLogin();
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    if (e.target.closest('#register-btn')) {
                        this.handleRegister();
                        return;
                    }
                    
                    // –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                    if (e.target.closest('.menu-item')) {
                        const menuItem = e.target.closest('.menu-item');
                        const menu = menuItem.dataset.menu;
                        
                        this.showScreen(menu);
                        this.closeMobileSidebar();
                        return;
                    }
                    
                    // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
                    if (e.target.closest('#mobile-menu-btn')) {
                        this.toggleMobileSidebar();
                        return;
                    }
                    
                    if (e.target.closest('#sidebar-overlay')) {
                        this.closeMobileSidebar();
                        return;
                    }
                    
                    if (e.target.closest('#back-to-chats-btn')) {
                        this.closeMobileChat();
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∏ –≤ —á–∞—Ç–∞—Ö
                    if (e.target.closest('#send-button')) {
                        this.sendMessage();
                        return;
                    }
                    
                    // –£–î–ê–õ–ï–ù–ê –ö–ù–û–ü–ö–ê –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                    if (e.target.closest('#delete-chat-btn')) {
                        this.deleteCurrentChat();
                        return;
                    }
                    
                    if (e.target.closest('#user-profile-btn')) {
                        if (this.currentChat && this.currentChat.userId) {
                            this.showUserProfile(this.currentChat.userId);
                        }
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                    if (e.target.closest('#logout-settings-btn')) {
                        this.logout();
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∏ –ø–æ—Å—Ç–æ–≤
                    if (e.target.closest('#refresh-posts-btn')) {
                        this.renderPosts().then(() => {
                            this.showNotification('–õ–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                        });
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    if (e.target.closest('#save-profile-btn')) {
                        this.saveProfile();
                        return;
                    }
                    
                    // –£–î–ê–õ–ï–ù–ê –ö–ù–û–ü–ö–ê –°–ú–ï–ù–ò–¢–¨ –ü–ê–†–û–õ–¨
                    if (e.target.closest('#delete-all-chats-btn')) {
                        this.deleteAllChatsConfirmation();
                        return;
                    }
                    
                    if (e.target.closest('#delete-account-btn')) {
                        this.deleteAccountConfirmation();
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
                    if (e.target.closest('#admin-view-all-users')) {
                        this.showAllUsersAdmin();
                        return;
                    }
                    
                    if (e.target.closest('#admin-create-user')) {
                        this.createUserAdmin();
                        return;
                    }
                    
                    if (e.target.closest('#admin-view-all-posts')) {
                        this.showAllPostsAdmin();
                        return;
                    }
                    
                    if (e.target.closest('#admin-export-data')) {
                        this.exportData();
                        return;
                    }
                    
                    if (e.target.closest('#admin-clear-posts')) {
                        this.clearAllPostsConfirmation();
                        return;
                    }
                    
                    if (e.target.closest('#admin-clear-all-data')) {
                        this.clearAllDataConfirmation();
                        return;
                    }
                    
                    // –ù–æ–≤—ã–µ –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫–∏
                    if (e.target.closest('#admin-edit-user')) {
                        this.editUserAdmin();
                        return;
                    }
                    
                    if (e.target.closest('#admin-ban-user')) {
                        this.banUserAdminModal();
                        return;
                    }
                    
                    if (e.target.closest('#admin-unban-user')) {
                        this.unbanUserAdminModal();
                        return;
                    }
                    
                    if (e.target.closest('#admin-grant-admin')) {
                        this.grantAdminModal();
                        return;
                    }
                    
                    if (e.target.closest('#admin-revoke-admin')) {
                        this.revokeAdminModal();
                        return;
                    }
                    
                    if (e.target.closest('#admin-edit-post')) {
                        this.editPostAdmin();
                        return;
                    }
                    
                    if (e.target.closest('#admin-delete-post')) {
                        this.editPostAdmin();
                        return;
                    }
                    
                    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏
                    if (e.target.closest('#edit-emoji-field')) {
                        const currentEmoji = document.getElementById('current-emoji');
                        const emoji = prompt('–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏ (1-2 —Å–∏–º–≤–æ–ª–∞):', currentEmoji?.textContent || 'üë§');
                        if (emoji && emoji.trim().length <= 2 && currentEmoji) {
                            currentEmoji.textContent = emoji.trim();
                        }
                        return;
                    }
                    
                    // –í—ã–±–æ—Ä —Ç–µ–º—ã
                    if (e.target.closest('.theme-option')) {
                        const themeOption = e.target.closest('.theme-option');
                        const theme = themeOption.dataset.theme;
                        this.changeTheme(theme);
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                    if (e.target.closest('#create-post-settings-btn')) {
                        this.createPostModal();
                        return;
                    }
                    
                    // –ö–Ω–æ–ø–∫–∞ –±—ç–∫–∞–ø–∞ –¥–∞–Ω–Ω—ã—Ö
                    if (e.target.closest('#admin-backup')) {
                        this.backupData();
                        return;
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
                document.addEventListener('change', (e) => {
                    if (e.target.id === 'private-profile-toggle' || 
                        e.target.id === 'show-status-toggle' ||
                        e.target.id === 'site-notifications-toggle' ||
                        e.target.id === 'sound-toggle' ||
                        e.target.id === 'notification-messages' ||
                        e.target.id === 'notification-posts' ||
                        e.target.id === 'notification-system' ||
                        e.target.id === 'message-permissions') {
                        this.saveUserSettings();
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–∑—É–Ω–∫–æ–≤
                    if (e.target.id === 'font-size-slider') {
                        const value = e.target.value;
                        document.getElementById('font-size-value').textContent = value + 'px';
                        document.documentElement.style.fontSize = value + 'px';
                        this.saveUserSettings();
                    }
                    
                    if (e.target.id === 'density-slider') {
                        const value = e.target.value;
                        document.getElementById('density-value').textContent = value;
                        this.applyDensity(value);
                        this.saveUserSettings();
                    }
                    
                    if (e.target.id === 'opacity-slider') {
                        const value = e.target.value;
                        document.getElementById('opacity-value').textContent = value + '%';
                        this.applyOpacity(value);
                        this.saveUserSettings();
                    }
                    
                    if (e.target.id === 'volume-slider') {
                        const value = e.target.value;
                        document.getElementById('volume-value').textContent = value + '%';
                        this.saveUserSettings();
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è –≤—Ö–æ–¥–∞
                document.addEventListener('keypress', (e) => {
                    if (e.target.id === 'login-password' && e.key === 'Enter') {
                        this.handleLogin();
                    }
                    
                    if (e.target.id === 'message-input' && e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
                const searchInput = document.getElementById('search-users-input');
                if (searchInput) {
                    const debouncedSearch = this.debounce((e) => {
                        this.renderSearchResults(e.target.value);
                    }, 300);
                    
                    searchInput.addEventListener('input', debouncedSearch);
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.addEventListener('input', () => {
                        this.adjustTextareaHeight(messageInput);
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç–º–æ–¥–∑–∏
                const regEmoji = document.getElementById('reg-emoji');
                const regEmojiPreview = document.getElementById('reg-emoji-preview');
                if (regEmoji && regEmojiPreview) {
                    regEmoji.addEventListener('input', function() {
                        regEmojiPreview.innerHTML = this.value || 'üë§';
                    });
                }
            }
            
            toggleMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar && overlay) {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                }
            }
            
            closeMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }
            }
            
            closeMobileChat() {
                if (window.innerWidth <= 767) {
                    const activeChatContainer = document.getElementById('active-chat-container');
                    const noChatSelected = document.getElementById('no-chat-selected');
                    const backBtn = document.getElementById('back-to-chats-btn');
                    
                    if (activeChatContainer) activeChatContainer.classList.add('hidden');
                    if (noChatSelected) noChatSelected.classList.remove('hidden');
                    if (backBtn) backBtn.style.display = 'none';
                    
                    this.currentChat = null;
                }
            }
            
            async handleLogin() {
                const username = document.getElementById('login-username')?.value.trim() || '';
                const password = document.getElementById('login-password')?.value.trim() || '';
                
                if (!username || !password) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å', 'error');
                    return;
                }
                
                await this.login(username, password);
            }
            
            async handleRegister() {
                const firstname = document.getElementById('reg-firstname')?.value.trim() || '';
                const lastname = document.getElementById('reg-lastname')?.value.trim() || '';
                const username = document.getElementById('reg-username')?.value.trim() || '';
                const password = document.getElementById('reg-password')?.value.trim() || '';
                const passwordConfirm = document.getElementById('reg-password-confirm')?.value.trim() || '';
                const emoji = document.getElementById('reg-emoji')?.value.trim() || 'üë§';
                const terms = document.getElementById('reg-terms')?.checked || false;
                
                if (!firstname || !lastname || !username || !password || !passwordConfirm) {
                    this.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                if (!terms) {
                    this.showNotification('–ü—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', 'error');
                    return;
                }
                
                const userData = {
                    firstname,
                    lastname,
                    username,
                    password,
                    passwordConfirm,
                    emoji
                };
                
                await this.register(userData);
            }
            
            async deleteAccountConfirmation() {
                const confirmed = await this.showConfirmationModal(
                    '–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.',
                    'danger'
                );
                
                if (confirmed) {
                    await this.deleteAccount();
                }
            }
            
            async deleteAccount() {
                try {
                    await this.deleteUser(this.currentUser.id);
                    this.logout();
                    this.showNotification('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω', 'info');
                } catch (error) {
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞', 'error');
                }
            }
            
            // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
            
            async init() {
                try {
                    await this.initTestData();
                    await this.checkAuth();
                    this.setupRealtimeSubscriptions();
                    console.log('RedMessenger PRO –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'error');
                }
            }
            
            // ========== SUPABASE API –ú–ï–¢–û–î–´ ==========
            
            async supabaseFetch(endpoint, method = 'GET', body = null, additionalHeaders = {}) {
                try {
                    const options = {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Prefer': 'return=representation',
                            ...additionalHeaders
                        }
                    };
                    
                    if (body) {
                        options.body = JSON.stringify(body);
                    }
                    
                    const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Supabase –æ—à–∏–±–∫–∞:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const text = await response.text();
                        return text ? JSON.parse(text) : (method === 'GET' ? [] : {});
                    }
                    
                    return method === 'GET' ? [] : {};
                } catch (error) {
                    console.error('Supabase –æ—à–∏–±–∫–∞:', error);
                    return method === 'GET' ? [] : {};
                }
            }
            
            async supabaseFetchWithParams(endpoint, method = 'GET', body = null, params = {}) {
                try {
                    let url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                    
                    if (Object.keys(params).length > 0) {
                        url += '?';
                        const queryParams = [];
                        
                        for (const [key, value] of Object.entries(params)) {
                            if (value !== null && value !== undefined) {
                                queryParams.push(`${key}=eq.${encodeURIComponent(value)}`);
                            }
                        }
                        
                        url += queryParams.join('&');
                    }
                    
                    const options = {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Prefer': 'return=representation'
                        }
                    };
                    
                    if (body) {
                        options.body = JSON.stringify(body);
                    }
                    
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Supabase –æ—à–∏–±–∫–∞:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const text = await response.text();
                        return text ? JSON.parse(text) : (method === 'GET' ? [] : {});
                    }
                    
                    return method === 'GET' ? [] : {};
                } catch (error) {
                    console.error('Supabase –æ—à–∏–±–∫–∞:', error);
                    return method === 'GET' ? [] : {};
                }
            }
            
            async supabaseFetchWithSelect(endpoint, select = '*', params = {}) {
                try {
                    let url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                    
                    url += `?select=${encodeURIComponent(select)}`;
                    
                    if (Object.keys(params).length > 0) {
                        url += '&';
                        const queryParams = [];
                        
                        for (const [key, value] of Object.entries(params)) {
                            if (value !== null && value !== undefined) {
                                queryParams.push(`${key}=eq.${encodeURIComponent(value)}`);
                            }
                        }
                        
                        url += queryParams.join('&');
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Supabase –æ—à–∏–±–∫–∞:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const text = await response.text();
                        return text ? JSON.parse(text) : [];
                    }
                    
                    return [];
                } catch (error) {
                    console.error('Supabase –æ—à–∏–±–∫–∞:', error);
                    return [];
                }
            }
            
            async supabaseFetchWithFilter(endpoint, filter = {}) {
                try {
                    let url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                    
                    const queryParams = [];
                    for (const [key, value] of Object.entries(filter)) {
                        if (value !== null && value !== undefined) {
                            queryParams.push(`${key}=${encodeURIComponent(value)}`);
                        }
                    }
                    
                    if (queryParams.length > 0) {
                        url += '?' + queryParams.join('&');
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Supabase –æ—à–∏–±–∫–∞:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const text = await response.text();
                        return text ? JSON.parse(text) : [];
                    }
                    
                    return [];
                } catch (error) {
                    console.error('Supabase –æ—à–∏–±–∫–∞:', error);
                    return [];
                }
            }
            
            // ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==========
            
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            async createUser(userData) {
                try {
                    const response = await this.supabaseFetch('users', 'POST', userData);
                    return response && response[0] ? response[0] : userData;
                } catch (error) {
                    console.error('Error creating user:', error);
                    throw error;
                }
            }
            
            async getUserById(userId) {
                try {
                    const response = await this.supabaseFetchWithSelect('users', '*', { id: userId });
                    return response && response[0] ? response[0] : null;
                } catch (error) {
                    console.error('Error getting user:', error);
                    return null;
                }
            }
            
            async getUserByUsername(username) {
                try {
                    const response = await this.supabaseFetchWithSelect('users', '*', { username: username });
                    return response && response[0] ? response[0] : null;
                } catch (error) {
                    console.error('Error getting user by username:', error);
                    return null;
                }
            }
            
            async getAllUsers() {
                try {
                    const response = await this.supabaseFetchWithSelect('users', '*');
                    return Array.isArray(response) ? response : [];
                } catch (error) {
                    console.error('Error getting all users:', error);
                    return [];
                }
            }
            
            async updateUser(userId, userData) {
                try {
                    const response = await this.supabaseFetch(`users?id=eq.${userId}`, 'PATCH', userData);
                    return response && response[0] ? response[0] : userData;
                } catch (error) {
                    console.error('Error updating user:', error);
                    throw error;
                }
            }
            
            async updateUserStatus(userId, status) {
                return this.updateUser(userId, { 
                    status, 
                    last_seen: new Date().toISOString() 
                });
            }
            
            async deleteUser(userId) {
                try {
                    await this.supabaseFetch(`users?id=eq.${userId}`, 'DELETE');
                    return true;
                } catch (error) {
                    console.error('Error deleting user:', error);
                    throw error;
                }
            }
            
            // ========== –ß–ê–¢–´ ==========
            
            async createChat(participants, type = 'private') {
                try {
                    const chatData = {
                        id: this.generateUUID(),
                        participants: JSON.stringify(participants),
                        type,
                        last_message: '',
                        last_message_time: new Date().toISOString()
                    };
                    
                    const response = await this.supabaseFetch('chats', 'POST', chatData);
                    return response && response[0] ? response[0] : chatData;
                } catch (error) {
                    console.error('Error creating chat:', error);
                    throw error;
                }
            }
            
            async getChatsByUserId(userId) {
                try {
                    const allChats = await this.supabaseFetchWithSelect('chats', '*');
                    if (!Array.isArray(allChats)) return [];
                    
                    return allChats.filter(chat => {
                        try {
                            const participants = JSON.parse(chat.participants || '[]');
                            return Array.isArray(participants) && participants.includes(userId);
                        } catch {
                            return false;
                        }
                    });
                } catch (error) {
                    console.error('Error getting chats:', error);
                    return [];
                }
            }
            
            async getChatBetweenUsers(userId1, userId2) {
                try {
                    const allChats = await this.supabaseFetchWithSelect('chats', '*');
                    if (!Array.isArray(allChats)) return null;
                    
                    return allChats.find(chat => {
                        try {
                            const participants = JSON.parse(chat.participants || '[]');
                            return Array.isArray(participants) && 
                                   participants.includes(userId1) && 
                                   participants.includes(userId2) && 
                                   participants.length === 2;
                        } catch {
                            return false;
                        }
                    });
                } catch (error) {
                    console.error('Error getting chat between users:', error);
                    return null;
                }
            }
            
            async updateChat(chatId, chatData) {
                try {
                    const response = await this.supabaseFetch(`chats?id=eq.${chatId}`, 'PATCH', chatData);
                    return response && response[0] ? response[0] : chatData;
                } catch (error) {
                    console.error('Error updating chat:', error);
                    throw error;
                }
            }
            
            async deleteChat(chatId) {
                try {
                    await this.supabaseFetch(`chats?id=eq.${chatId}`, 'DELETE');
                    return true;
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    throw error;
                }
            }
            
            // ========== –°–û–û–ë–©–ï–ù–ò–Ø ==========
            
            async createMessage(chatId, senderId, content) {
                try {
                    const messageData = {
                        id: this.generateUUID(),
                        chat_id: chatId,
                        sender_id: senderId,
                        content,
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    const response = await this.supabaseFetch('messages', 'POST', messageData);
                    return response && response[0] ? response[0] : messageData;
                } catch (error) {
                    console.error('Error creating message:', error);
                    throw error;
                }
            }
            
            async getMessagesByChatId(chatId) {
                try {
                    const response = await this.supabaseFetchWithSelect('messages', '*', { chat_id: chatId });
                    if (!Array.isArray(response)) return [];
                    
                    return response.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                } catch (error) {
                    console.error('Error getting messages:', error);
                    return [];
                }
            }
            
            async getNewMessages(chatId, lastCheck) {
                try {
                    const response = await this.supabaseFetchWithFilter('messages', {
                        chat_id: `eq.${chatId}`,
                        timestamp: `gte.${new Date(lastCheck).toISOString()}`
                    });
                    
                    return Array.isArray(response) ? response : [];
                } catch (error) {
                    console.error('Error getting new messages:', error);
                    return [];
                }
            }
            
            async markMessagesAsRead(chatId, userId) {
                try {
                    const messages = await this.getMessagesByChatId(chatId);
                    const unreadMessages = messages.filter(m => m.sender_id !== userId && !m.read);
                    
                    for (const message of unreadMessages) {
                        await this.supabaseFetch(`messages?id=eq.${message.id}`, 'PATCH', {
                            read: true
                        });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                    return false;
                }
            }
            
            async getMessageById(messageId) {
                try {
                    const response = await this.supabaseFetchWithSelect('messages', '*', { id: messageId });
                    return response && response[0] ? response[0] : null;
                } catch (error) {
                    console.error('Error getting message by id:', error);
                    return null;
                }
            }
            
            async deleteMessage(messageId) {
                try {
                    await this.supabaseFetch(`messages?id=eq.${messageId}`, 'DELETE');
                    return true;
                } catch (error) {
                    console.error('Error deleting message:', error);
                    throw error;
                }
            }
            
            // ========== –ü–û–°–¢–´ ==========
            
            async createPost(authorId, content, hashtags = []) {
                try {
                    const postData = {
                        id: this.generateUUID(),
                        author_id: authorId,
                        content,
                        hashtags: JSON.stringify(hashtags),
                        timestamp: new Date().toISOString()
                    };
                    
                    const response = await this.supabaseFetch('posts', 'POST', postData);
                    return response && response[0] ? response[0] : postData;
                } catch (error) {
                    console.error('Error creating post:', error);
                    throw error;
                }
            }
            
            async getAllPosts() {
                try {
                    const response = await this.supabaseFetchWithSelect('posts', '*');
                    if (!Array.isArray(response)) return [];
                    
                    return response.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 50);
                } catch (error) {
                    console.error('Error getting posts:', error);
                    return [];
                }
            }
            
            async getPostById(postId) {
                try {
                    const response = await this.supabaseFetchWithSelect('posts', '*', { id: postId });
                    return response && response[0] ? response[0] : null;
                } catch (error) {
                    console.error('Error getting post:', error);
                    return null;
                }
            }
            
            async updatePost(postId, postData) {
                try {
                    const response = await this.supabaseFetch(`posts?id=eq.${postId}`, 'PATCH', postData);
                    return response && response[0] ? response[0] : postData;
                } catch (error) {
                    console.error('Error updating post:', error);
                    throw error;
                }
            }
            
            async deletePost(postId) {
                try {
                    await this.supabaseFetch(`posts?id=eq.${postId}`, 'DELETE');
                    return true;
                } catch (error) {
                    console.error('Error deleting post:', error);
                    throw error;
                }
            }
            
            // ========== –†–ï–ê–ö–¶–ò–ò ==========
            
            async createReaction(postId, userId, reactionType) {
                try {
                    const existingReactions = await this.supabaseFetchWithSelect('post_reactions', '*', { 
                        post_id: postId, 
                        user_id: userId 
                    });
                    
                    if (existingReactions && existingReactions.length > 0) {
                        const reactionId = existingReactions[0].id;
                        await this.supabaseFetch(`post_reactions?id=eq.${reactionId}`, 'PATCH', {
                            reaction_type: reactionType
                        });
                        return existingReactions[0];
                    } else {
                        const reactionData = {
                            id: this.generateUUID(),
                            post_id: postId,
                            user_id: userId,
                            reaction_type: reactionType
                        };
                        
                        const response = await this.supabaseFetch('post_reactions', 'POST', reactionData);
                        return response && response[0] ? response[0] : reactionData;
                    }
                } catch (error) {
                    console.error('Error creating reaction:', error);
                    throw error;
                }
            }
            
            async getReactionsByPostId(postId) {
                try {
                    const response = await this.supabaseFetchWithSelect('post_reactions', '*', { post_id: postId });
                    return Array.isArray(response) ? response : [];
                } catch (error) {
                    console.error('Error getting reactions:', error);
                    return [];
                }
            }
            
            async getReactionByUserAndPost(postId, userId) {
                try {
                    const response = await this.supabaseFetchWithSelect('post_reactions', '*', { 
                        post_id: postId, 
                        user_id: userId 
                    });
                    return response && response[0] ? response[0] : null;
                } catch (error) {
                    console.error('Error getting reaction:', error);
                    return null;
                }
            }
            
            async deleteReaction(reactionId) {
                try {
                    await this.supabaseFetch(`post_reactions?id=eq.${reactionId}`, 'DELETE');
                    return true;
                } catch (error) {
                    console.error('Error deleting reaction:', error);
                    throw error;
                }
            }
            
            // ========== –ë–õ–û–ö–ò–†–û–í–ö–ò ==========
            
            async createBlock(blockerId, blockedId) {
                try {
                    const blockData = {
                        id: this.generateUUID(),
                        blocker_id: blockerId,
                        blocked_id: blockedId,
                        timestamp: new Date().toISOString()
                    };
                    
                    const response = await this.supabaseFetch('blocked_users', 'POST', blockData);
                    return response && response[0] ? response[0] : blockData;
                } catch (error) {
                    console.error('Error creating block:', error);
                    throw error;
                }
            }
            
            async getBlocksByBlockerId(blockerId) {
                try {
                    const response = await this.supabaseFetchWithSelect('blocked_users', '*', { blocker_id: blockerId });
                    return Array.isArray(response) ? response : [];
                } catch (error) {
                    console.error('Error getting blocks:', error);
                    return [];
                }
            }
            
            async getBlocksByBlockedId(blockedId) {
                try {
                    const response = await this.supabaseFetchWithSelect('blocked_users', '*', { blocked_id: blockedId });
                    return Array.isArray(response) ? response : [];
                } catch (error) {
                    console.error('Error getting blocks:', error);
                    return [];
                }
            }
            
            async deleteBlock(blockerId, blockedId) {
                try {
                    const blocks = await this.supabaseFetchWithSelect('blocked_users', '*', { 
                        blocker_id: blockerId, 
                        blocked_id: blockedId 
                    });
                    
                    if (blocks && blocks.length > 0) {
                        await this.supabaseFetch(`blocked_users?id=eq.${blocks[0].id}`, 'DELETE');
                        return true;
                    }
                    
                    return false;
                } catch (error) {
                    console.error('Error deleting block:', error);
                    throw error;
                }
            }
            
            async isBlocked(blockerId, blockedId) {
                try {
                    const blocks = await this.supabaseFetchWithSelect('blocked_users', '*', { 
                        blocker_id: blockerId, 
                        blocked_id: blockedId 
                    });
                    return blocks && blocks.length > 0;
                } catch (error) {
                    console.error('Error checking block:', error);
                    return false;
                }
            }
            
            // ========== –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï ==========
            
            async initTestData() {
                try {
                    const users = await this.getAllUsers();
                    
                    if (users.length === 0) {
                        const adminUser = {
                            id: '00000000-0000-0000-0000-000000000001',
                            firstname: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                            lastname: '–°–∏—Å—Ç–µ–º—ã',
                            username: '@admin',
                            password: 'admin123',
                            emoji: 'üëë',
                            bio: '–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä RedMessenger PRO',
                            status: 'online',
                            role: 'admin',
                            is_private: false,
                            is_banned: false,
                            settings: JSON.stringify({
                                privateProfile: false,
                                showStatus: true,
                                darkTheme: true,
                                compactMode: false,
                                sound: true,
                                messageNotifications: true,
                                postNotifications: false,
                                messagePermissions: 'all',
                                fontSize: 14,
                                density: 3,
                                opacity: 100,
                                volume: 50,
                                theme: 'dark',
                                notifications: {
                                    site: true,
                                    messages: true,
                                    posts: false,
                                    system: true,
                                    sound: true,
                                    volume: 50
                                }
                            }),
                            last_seen: new Date().toISOString()
                        };
                        
                        const testUser = {
                            id: '00000000-0000-0000-0000-000000000002',
                            firstname: '–ê–ª–µ–∫—Å–µ–π',
                            lastname: '–ò–≤–∞–Ω–æ–≤',
                            username: '@alex',
                            password: 'alex123',
                            emoji: 'üë®‚Äçüíª',
                            bio: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ü–û, –ª—é–±–ª—é –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏',
                            status: 'online',
                            role: 'user',
                            is_private: false,
                            is_banned: false,
                            settings: JSON.stringify({
                                privateProfile: false,
                                showStatus: true,
                                darkTheme: true,
                                compactMode: false,
                                sound: true,
                                messageNotifications: true,
                                postNotifications: false,
                                messagePermissions: 'all',
                                fontSize: 14,
                                density: 3,
                                opacity: 100,
                                volume: 50,
                                theme: 'dark',
                                notifications: {
                                    site: true,
                                    messages: true,
                                    posts: false,
                                    system: true,
                                    sound: true,
                                    volume: 50
                                }
                            }),
                            last_seen: new Date().toISOString()
                        };
                        
                        await this.createUser(adminUser);
                        await this.createUser(testUser);
                    }
                } catch (error) {
                    console.error('Error initializing test data:', error);
                }
            }
            
            // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
            
            async login(username, password) {
                if (this.isLoading) return false;
                this.isLoading = true;
                
                try {
                    const loginBtn = document.getElementById('login-btn');
                    if (loginBtn) {
                        loginBtn.innerHTML = '<div class="loader"></div>';
                        loginBtn.disabled = true;
                    }
                    
                    let searchUsername = username.trim();
                    if (!searchUsername.startsWith('@')) {
                        searchUsername = '@' + searchUsername;
                    }
                    
                    const user = await this.getUserByUsername(searchUsername);
                    
                    if (!user) {
                        this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        return false;
                    }
                    
                    if (user.password !== password) {
                        this.showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                        return false;
                    }
                    
                    if (user.role !== 'admin' && user.is_banned) {
                        this.showNotification('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'error');
                        return false;
                    }
                    
                    await this.updateUserStatus(user.id, 'online');
                    
                    user.status = 'online';
                    user.last_seen = new Date().toISOString();
                    
                    this.currentUser = user;
                    localStorage.setItem('redmessenger_pro_current_user', JSON.stringify(this.currentUser));
                    
                    this.startApp();
                    this.showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.firstname}!`, 'success');
                    
                    return true;
                } catch (error) {
                    console.error('Login error:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                    return false;
                } finally {
                    this.isLoading = false;
                    const loginBtn = document.getElementById('login-btn');
                    if (loginBtn) {
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏';
                        loginBtn.disabled = false;
                    }
                }
            }
            
            async register(userData) {
                if (this.isLoading) return false;
                this.isLoading = true;
                
                try {
                    const registerBtn = document.getElementById('register-btn');
                    if (registerBtn) {
                        registerBtn.innerHTML = '<div class="loader"></div>';
                        registerBtn.disabled = true;
                    }
                    
                    let username = userData.username.trim();
                    if (!username.startsWith('@')) {
                        username = '@' + username;
                    }
                    
                    if (!/^@[a-zA-Z0-9_]+$/.test(username)) {
                        this.showNotification('–Æ–∑–µ—Ä–Ω–µ–π–º –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è', 'error');
                        return false;
                    }
                    
                    if (userData.password.length < 6) {
                        this.showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                        return false;
                    }
                    
                    if (userData.password !== userData.passwordConfirm) {
                        this.showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                        return false;
                    }
                    
                    const existingUser = await this.getUserByUsername(username);
                    if (existingUser) {
                        this.showNotification('–≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç', 'error');
                        return false;
                    }
                    
                    const newUser = {
                        id: this.generateUUID(),
                        firstname: userData.firstname,
                        lastname: userData.lastname,
                        username: username,
                        password: userData.password,
                        emoji: userData.emoji || 'üë§',
                        bio: '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å RedMessenger PRO',
                        status: 'online',
                        role: 'user',
                        is_private: false,
                        is_banned: false,
                        settings: JSON.stringify({
                            privateProfile: false,
                            showStatus: true,
                            darkTheme: true,
                            compactMode: false,
                            sound: true,
                            messageNotifications: true,
                            postNotifications: false,
                            messagePermissions: 'all',
                            fontSize: 14,
                            density: 3,
                            opacity: 100,
                            volume: 50,
                            theme: 'dark',
                            notifications: {
                                site: true,
                                messages: true,
                                posts: false,
                                system: true,
                                sound: true,
                                volume: 50
                            }
                        }),
                        last_seen: new Date().toISOString()
                    };
                    
                    await this.createUser(newUser);
                    
                    this.currentUser = newUser;
                    localStorage.setItem('redmessenger_pro_current_user', JSON.stringify(this.currentUser));
                    
                    this.startApp();
                    this.showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                    
                    return true;
                } catch (error) {
                    console.error('Register error:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                    return false;
                } finally {
                    this.isLoading = false;
                    const registerBtn = document.getElementById('register-btn');
                    if (registerBtn) {
                        registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                        registerBtn.disabled = false;
                    }
                }
            }
            
            async logout() {
                if (this.currentUser) {
                    try {
                        await this.updateUserStatus(this.currentUser.id, 'offline');
                    } catch (error) {
                        console.error('Error updating status on logout:', error);
                    }
                }
                
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
                
                if (this.messagePollingInterval) {
                    clearInterval(this.messagePollingInterval);
                    this.messagePollingInterval = null;
                }
                
                this.currentUser = null;
                localStorage.removeItem('redmessenger_pro_current_user');
                
                const appContainer = document.getElementById('app-container');
                const authContainer = document.getElementById('auth-container');
                
                if (appContainer) appContainer.classList.remove('active');
                if (authContainer) authContainer.style.display = 'flex';
                
                this.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
            }
            
            async checkAuth() {
                try {
                    const savedUser = localStorage.getItem('redmessenger_pro_current_user');
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        if (user && user.id) {
                            const dbUser = await this.getUserById(user.id);
                            if (dbUser) {
                                this.currentUser = dbUser;
                                await this.updateUserStatus(user.id, 'online');
                                this.currentUser.status = 'online';
                                this.currentUser.last_seen = new Date().toISOString();
                                this.startApp();
                            } else {
                                this.logout();
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking auth:', error);
                    this.logout();
                }
            }
            
            startApp() {
                const authContainer = document.getElementById('auth-container');
                const appContainer = document.getElementById('app-container');
                
                if (authContainer) authContainer.style.display = 'none';
                if (appContainer) appContainer.classList.add('active');
                
                this.updateUserInterface();
                this.loadSettings();
                this.loadChats();
                this.renderPosts();
                this.setupRealtimeSubscriptions();
                this.startMessagePolling();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
                const mobileTitle = document.getElementById('mobile-title');
                if (mobileTitle && this.currentUser) {
                    mobileTitle.textContent = this.currentUser.firstname;
                }
            }
            
            // ========== –ò–ù–¢–ï–†–§–ï–ô–° ==========
            
            updateUserInterface() {
                if (!this.currentUser) return;
                
                const avatarText = document.getElementById('avatar-text');
                const userName = document.getElementById('user-name');
                const userUsername = document.getElementById('user-username');
                const currentEmoji = document.getElementById('current-emoji');
                const editFirstname = document.getElementById('edit-firstname');
                const editLastname = document.getElementById('edit-lastname');
                const editBio = document.getElementById('edit-bio');
                const adminMenuItem = document.getElementById('admin-menu-item');
                
                if (avatarText) avatarText.textContent = this.currentUser.emoji || 'üë§';
                if (userName) userName.textContent = this.currentUser.firstname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                if (userUsername) userUsername.textContent = this.currentUser.username || '@username';
                if (currentEmoji) currentEmoji.textContent = this.currentUser.emoji || 'üë§';
                if (editFirstname) editFirstname.value = this.currentUser.firstname || '';
                if (editLastname) editLastname.value = this.currentUser.lastname || '';
                if (editBio) editBio.value = this.currentUser.bio || '';
                
                if (adminMenuItem) {
                    adminMenuItem.style.display = 
                        this.currentUser.role === 'admin' ? 'flex' : 'none';
                }
            }
            
            showScreen(screen) {
                const screens = ['chats-screen', 'posts-screen', 'search-screen', 'settings-screen', 'admin-screen'];
                screens.forEach(s => {
                    const element = document.getElementById(s);
                    if (element) element.classList.add('hidden');
                });
                
                const activeChatContainer = document.getElementById('active-chat-container');
                const noChatSelected = document.getElementById('no-chat-selected');
                const backBtn = document.getElementById('back-to-chats-btn');
                
                if (screen !== 'chats' && activeChatContainer) {
                    activeChatContainer.classList.add('hidden');
                    if (noChatSelected) noChatSelected.classList.remove('hidden');
                    if (backBtn) backBtn.style.display = 'none';
                }
                
                const targetScreen = document.getElementById(`${screen}-screen`);
                if (targetScreen) targetScreen.classList.remove('hidden');
                
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const menuItem = document.querySelector(`[data-menu="${screen}"]`);
                if (menuItem) menuItem.classList.add('active');
                
                this.currentMenu = screen;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
                const mobileTitle = document.getElementById('mobile-title');
                if (mobileTitle) {
                    const titles = {
                        'chats': '–ß–∞—Ç—ã',
                        'posts': '–ü–æ—Å—Ç—ã',
                        'search': '–ü–æ–∏—Å–∫',
                        'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                        'admin': '–ê–¥–º–∏–Ω'
                    };
                    mobileTitle.textContent = titles[screen] || 'RedMessenger';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
                setTimeout(() => {
                    switch(screen) {
                        case 'chats':
                            this.loadChats();
                            break;
                        case 'posts':
                            this.renderPosts();
                            break;
                        case 'search':
                            this.renderSearchResults();
                            break;
                        case 'settings':
                            this.loadSettings();
                            break;
                        case 'admin':
                            this.renderAdminPanel();
                            break;
                    }
                }, 0);
                
                this.closeMobileSidebar();
            }
            
            // ========== –ù–ê–°–¢–†–û–ô–ö–ò –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø ==========
            
            async loadSettings() {
                if (!this.currentUser) return;
                
                try {
                    const user = await this.getUserById(this.currentUser.id);
                    if (user && user.settings) {
                        const settings = JSON.parse(user.settings);
                        
                        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
                        const privateProfileToggle = document.getElementById('private-profile-toggle');
                        const showStatusToggle = document.getElementById('show-status-toggle');
                        const soundToggle = document.getElementById('sound-toggle');
                        const messagePermissions = document.getElementById('message-permissions');
                        
                        if (privateProfileToggle) privateProfileToggle.checked = settings.privateProfile || false;
                        if (showStatusToggle) showStatusToggle.checked = settings.showStatus !== false;
                        if (soundToggle) soundToggle.checked = settings.sound !== false;
                        if (messagePermissions) messagePermissions.value = settings.messagePermissions || 'all';
                        
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                        const siteNotificationsToggle = document.getElementById('site-notifications-toggle');
                        const notificationMessages = document.getElementById('notification-messages');
                        const notificationPosts = document.getElementById('notification-posts');
                        const notificationSystem = document.getElementById('notification-system');
                        
                        if (settings.notifications) {
                            this.notificationSettings = { ...settings.notifications };
                            
                            if (siteNotificationsToggle) siteNotificationsToggle.checked = this.notificationSettings.site !== false;
                            if (notificationMessages) notificationMessages.checked = this.notificationSettings.messages !== false;
                            if (notificationPosts) notificationPosts.checked = this.notificationSettings.posts || false;
                            if (notificationSystem) notificationSystem.checked = this.notificationSettings.system !== false;
                        } else {
                            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            this.notificationSettings = {
                                site: true,
                                messages: true,
                                posts: false,
                                system: true,
                                sound: true,
                                volume: 50
                            };
                        }
                        
                        // –ü–æ–ª–∑—É–Ω–∫–∏
                        const fontSizeSlider = document.getElementById('font-size-slider');
                        const fontSizeValue = document.getElementById('font-size-value');
                        const densitySlider = document.getElementById('density-slider');
                        const densityValue = document.getElementById('density-value');
                        const opacitySlider = document.getElementById('opacity-slider');
                        const opacityValue = document.getElementById('opacity-value');
                        const volumeSlider = document.getElementById('volume-slider');
                        const volumeValue = document.getElementById('volume-value');
                        
                        if (fontSizeSlider && fontSizeValue) {
                            fontSizeSlider.value = settings.fontSize || 14;
                            fontSizeValue.textContent = (settings.fontSize || 14) + 'px';
                            document.documentElement.style.fontSize = (settings.fontSize || 14) + 'px';
                        }
                        
                        if (densitySlider && densityValue) {
                            densitySlider.value = settings.density || 3;
                            densityValue.textContent = settings.density || 3;
                            this.applyDensity(settings.density || 3);
                        }
                        
                        if (opacitySlider && opacityValue) {
                            opacitySlider.value = settings.opacity || 100;
                            opacityValue.textContent = (settings.opacity || 100) + '%';
                            this.applyOpacity(settings.opacity || 100);
                        }
                        
                        if (volumeSlider && volumeValue) {
                            volumeSlider.value = this.notificationSettings.volume || 50;
                            volumeValue.textContent = (this.notificationSettings.volume || 50) + '%';
                        }
                        
                        // –¢–µ–º—ã
                        const theme = settings.theme || 'dark';
                        this.selectTheme(theme);
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∞–º–∏
                    await this.loadChatManagement();
                    
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
            
            async loadChatManagement() {
                const container = document.getElementById('chat-management-list');
                if (!container || !this.currentUser) return;
                
                try {
                    const userChats = await this.getChatsByUserId(this.currentUser.id);
                    
                    if (userChats.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;"></i>
                                <p>–£ –≤–∞—Å –Ω–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–æ–∫</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    for (const chat of userChats) {
                        try {
                            const participants = JSON.parse(chat.participants || '[]');
                            const otherUserId = participants.find(id => id !== this.currentUser.id);
                            const otherUser = await this.getUserById(otherUserId);
                            
                            if (!otherUser) continue;
                            
                            const isBlockedByMe = await this.isBlocked(this.currentUser.id, otherUserId);
                            
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div class="emoji-avatar small">
                                            ${otherUser.emoji || 'üë§'}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600;">${otherUser.firstname} ${otherUser.lastname}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">${otherUser.username}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn btn-danger btn-sm" data-action="delete-chat-management" data-chat-id="${chat.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error processing chat for management:', error);
                        }
                    }
                    
                    html += '</div>';
                    container.innerHTML = html;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                    container.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        
                        const action = target.dataset.action;
                        const chatId = target.dataset.chatId;
                        
                        switch(action) {
                            case 'delete-chat-management':
                                await this.deleteChatConfirmation(chatId);
                                await this.loadChatManagement();
                                break;
                        }
                    });
                    
                } catch (error) {
                    console.error('Error loading chat management:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–ø–∏—Å–æ–∫</p>
                        </div>
                    `;
                }
            }
            
            async toggleBlockUser(userId) {
                try {
                    const user = await this.getUserById(userId);
                    const isBlocked = await this.isBlocked(this.currentUser.id, userId);
                    
                    if (isBlocked) {
                        await this.deleteBlock(this.currentUser.id, userId);
                        this.showNotification(`–í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ ${user.firstname}`, 'success');
                    } else {
                        await this.createBlock(this.currentUser.id, userId);
                        this.showNotification(`–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ ${user.firstname}`, 'warning');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–æ–≤
                    await this.loadChats();
                    
                } catch (error) {
                    console.error('Error toggling block:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
                }
            }
            
            async saveUserSettings() {
                if (!this.currentUser) return;
                
                try {
                    // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    this.notificationSettings = {
                        site: document.getElementById('site-notifications-toggle')?.checked !== false,
                        messages: document.getElementById('notification-messages')?.checked !== false,
                        posts: document.getElementById('notification-posts')?.checked || false,
                        system: document.getElementById('notification-system')?.checked !== false,
                        sound: document.getElementById('sound-toggle')?.checked !== false,
                        volume: parseInt(document.getElementById('volume-slider')?.value || 50)
                    };
                    
                    const settings = {
                        privateProfile: document.getElementById('private-profile-toggle')?.checked || false,
                        showStatus: document.getElementById('show-status-toggle')?.checked !== false,
                        darkTheme: true,
                        compactMode: false,
                        sound: this.notificationSettings.sound,
                        messageNotifications: this.notificationSettings.messages,
                        postNotifications: this.notificationSettings.posts,
                        messagePermissions: document.getElementById('message-permissions')?.value || 'all',
                        fontSize: parseInt(document.getElementById('font-size-slider')?.value || 14),
                        density: parseInt(document.getElementById('density-slider')?.value || 3),
                        opacity: parseInt(document.getElementById('opacity-slider')?.value || 100),
                        theme: localStorage.getItem('redmessenger_theme') || 'dark',
                        notifications: this.notificationSettings
                    };
                    
                    await this.updateUser(this.currentUser.id, {
                        settings: JSON.stringify(settings),
                        is_private: settings.privateProfile
                    });
                    
                    this.currentUser.settings = JSON.stringify(settings);
                    this.currentUser.is_private = settings.privateProfile;
                    
                    if (!settings.showStatus) {
                        await this.updateUserStatus(this.currentUser.id, 'hidden');
                        this.currentUser.status = 'hidden';
                    } else if (this.currentUser.status === 'hidden') {
                        await this.updateUserStatus(this.currentUser.id, 'online');
                        this.currentUser.status = 'online';
                    }
                    
                    this.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                    
                    this.applyDensity(settings.density);
                    this.applyOpacity(settings.opacity);
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                }
            }
            
            async saveProfile() {
                if (!this.currentUser) return;
                
                const firstname = document.getElementById('edit-firstname')?.value.trim() || '';
                const lastname = document.getElementById('edit-lastname')?.value.trim() || '';
                const bio = document.getElementById('edit-bio')?.value.trim() || '';
                const emoji = document.getElementById('current-emoji')?.textContent.trim() || 'üë§';
                
                if (!firstname || !lastname) {
                    this.showNotification('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã', 'error');
                    return;
                }
                
                try {
                    const saveBtn = document.getElementById('save-profile-btn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<div class="loader"></div>';
                        saveBtn.disabled = true;
                    }
                    
                    await this.updateUser(this.currentUser.id, {
                        firstname,
                        lastname,
                        bio,
                        emoji
                    });
                    
                    this.currentUser.firstname = firstname;
                    this.currentUser.lastname = lastname;
                    this.currentUser.bio = bio;
                    this.currentUser.emoji = emoji;
                    
                    localStorage.setItem('redmessenger_pro_current_user', JSON.stringify(this.currentUser));
                    this.updateUserInterface();
                    
                    this.showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                } catch (error) {
                    console.error('Error saving profile:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                } finally {
                    const saveBtn = document.getElementById('save-profile-btn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
                        saveBtn.disabled = false;
                    }
                }
            }
            
            changeTheme(theme) {
                localStorage.setItem('redmessenger_theme', theme);
                this.selectTheme(theme);
                
                const themes = {
                    dark: { bg: '#0a0a0a', sidebar: '#111111', card: '#1a1a1a' },
                    light: { bg: '#f5f5f5', sidebar: '#ffffff', card: '#ffffff' },
                    red: { bg: '#2a0a0a', sidebar: '#3a1111', card: '#4a1a1a' },
                    blue: { bg: '#0a0a2a', sidebar: '#11113a', card: '#1a1a4a' },
                    green: { bg: '#0a2a0a', sidebar: '#113a11', card: '#1a4a1a' }
                };
                
                const themeColors = themes[theme] || themes.dark;
                
                document.documentElement.style.setProperty('--bg-color', themeColors.bg);
                document.documentElement.style.setProperty('--sidebar-bg', themeColors.sidebar);
                document.documentElement.style.setProperty('--card-bg', themeColors.card);
                
                if (theme === 'light') {
                    document.documentElement.style.setProperty('--text-primary', '#000000');
                    document.documentElement.style.setProperty('--text-secondary', '#666666');
                } else {
                    document.documentElement.style.setProperty('--text-primary', '#ffffff');
                    document.documentElement.style.setProperty('--text-secondary', '#aaaaaa');
                }
                
                this.saveUserSettings();
                this.showNotification(`–¢–µ–º–∞ "${theme}" –ø—Ä–∏–º–µ–Ω–µ–Ω–∞`, 'success');
            }
            
            selectTheme(theme) {
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                });
                
                const activeOption = document.querySelector(`.theme-option[data-theme="${theme}"]`);
                if (activeOption) {
                    activeOption.classList.add('active');
                }
            }
            
            applyDensity(value) {
                const elements = document.querySelectorAll('.message-bubble, .chat-item, .post-card, .settings-item');
                const padding = {
                    1: '5px',
                    2: '10px',
                    3: '15px',
                    4: '20px',
                    5: '25px'
                }[value] || '15px';
                
                const margin = {
                    1: '3px',
                    2: '5px',
                    3: '10px',
                    4: '15px',
                    5: '20px'
                }[value] || '10px';
                
                elements.forEach(el => {
                    el.style.padding = padding;
                    el.style.marginBottom = margin;
                });
            }
            
            applyOpacity(value) {
                const opacity = value / 100;
                document.querySelectorAll('.modal, .notification').forEach(el => {
                    el.style.opacity = opacity;
                });
            }
            
            // ========== –°–ò–°–¢–ï–ú–ê –ß–ê–¢–û–í ==========
            
            async loadChats() {
                const container = document.getElementById('chats-list');
                if (!container || !this.currentUser) return;
                
                if (this.isLoading) return;
                this.isLoading = true;
                
                try {
                    container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px; color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p></div>';
                    
                    const userChats = await this.getChatsByUserId(this.currentUser.id);
                    
                    if (userChats.length === 0) {
                        container.innerHTML = `
                            <div class="no-content" style="padding: 40px 20px;">
                                <i class="fas fa-comments no-content-icon"></i>
                                <h3>–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –ª—é–±—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    
                    for (const chat of userChats) {
                        try {
                            const participants = JSON.parse(chat.participants || '[]');
                            const otherUserId = participants.find(id => id !== this.currentUser.id);
                            const otherUser = await this.getUserById(otherUserId);
                            
                            if (!otherUser) continue;
                            
                            const messages = await this.getMessagesByChatId(chat.id);
                            const lastMessage = messages[messages.length - 1];
                            
                            const isBlockedByMe = await this.isBlocked(this.currentUser.id, otherUserId);
                            const isBlockedByOther = await this.isBlocked(otherUserId, this.currentUser.id);
                            
                            const unreadCount = messages.filter(m => 
                                m.sender_id !== this.currentUser.id && !m.read
                            ).length;
                            
                            const isBlocked = isBlockedByMe || isBlockedByOther;
                            
                            const userSettings = otherUser.settings ? JSON.parse(otherUser.settings) : {};
                            const showStatus = userSettings.showStatus !== false;
                            const isOnline = otherUser.status === 'online' && showStatus;
                            
                            html += `
                                <div class="chat-item ${unreadCount > 0 ? 'unread' : ''}" 
                                     data-chat-id="${chat.id}" data-user-id="${otherUserId}">
                                    <div class="chat-item-avatar">
                                        <div class="emoji-avatar small">
                                            ${otherUser.emoji || 'üë§'}
                                        </div>
                                        ${showStatus ? (isOnline ? 
                                            '<div class="online-dot"></div>' : 
                                            '<div class="offline-dot"></div>') : ''}
                                    </div>
                                    <div class="chat-info">
                                        <div class="chat-name">
                                            ${otherUser.firstname} ${otherUser.lastname}
                                            ${otherUser.role === 'admin' ? ' <span class="role-badge admin" style="font-size: 9px;">ADMIN</span>' : ''}
                                        </div>
                                        <div class="chat-last-message">
                                            ${isBlocked ? '<i class="fas fa-ban"></i> –ß–∞—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : 
                                              lastMessage ? (lastMessage.sender_id === this.currentUser.id ? '–í—ã: ' : '') + 
                                              lastMessage.content.substring(0, 30) + (lastMessage.content.length > 30 ? '...' : '') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}
                                        </div>
                                    </div>
                                    <div class="chat-meta">
                                        <div>${this.formatTime(chat.last_message_time)}</div>
                                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error processing chat:', error);
                        }
                    }
                    
                    container.innerHTML = html;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è —á–∞—Ç–æ–≤
                    container.querySelectorAll('.chat-item').forEach(item => {
                        item.addEventListener('click', async () => {
                            const chatId = item.dataset.chatId;
                            const userId = item.dataset.userId;
                            
                            const isBlockedByMe = await this.isBlocked(this.currentUser.id, userId);
                            const isBlockedByOther = await this.isBlocked(userId, this.currentUser.id);
                            
                            if (isBlockedByMe || isBlockedByOther) {
                                this.showNotification('–ß–∞—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                                return;
                            }
                            
                            this.openChat(chatId, userId);
                        });
                    });
                    
                } catch (error) {
                    console.error('Error loading chats:', error);
                    container.innerHTML = `
                        <div class="no-content" style="padding: 40px 20px;">
                            <i class="fas fa-exclamation-triangle no-content-icon"></i>
                            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    `;
                } finally {
                    this.isLoading = false;
                }
            }
            
            async openChat(chatId, userId) {
                if (this.isLoading) return;
                this.isLoading = true;
                
                try {
                    const user = await this.getUserById(userId);
                    if (!user) {
                        this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        return;
                    }
                    
                    this.currentChat = { id: chatId, userId: userId };
                    
                    const contactName = document.getElementById('contact-name');
                    const contactUsernameBadge = document.getElementById('contact-username-badge');
                    const contactAvatarText = document.getElementById('contact-avatar-text');
                    const contactStatusText = document.getElementById('contact-status-text');
                    const backBtn = document.getElementById('back-to-chats-btn');
                    
                    if (contactName) contactName.textContent = `${user.firstname} ${user.lastname}`;
                    if (contactUsernameBadge) contactUsernameBadge.textContent = user.username;
                    if (contactAvatarText) contactAvatarText.textContent = user.emoji || 'üë§';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                    if (backBtn && window.innerWidth <= 767) {
                        backBtn.style.display = 'flex';
                    }
                    
                    const userSettings = JSON.parse(user.settings || '{}');
                    if (contactStatusText) {
                        const showStatus = userSettings.showStatus !== false;
                        if (!showStatus) {
                            contactStatusText.textContent = '—Å–∫—Ä—ã—Ç';
                        } else if (user.status === 'online') {
                            contactStatusText.textContent = 'online';
                        } else {
                            contactStatusText.textContent = this.formatLastSeen(user.last_seen);
                        }
                    }
                    
                    const noChatSelected = document.getElementById('no-chat-selected');
                    const activeChatContainer = document.getElementById('active-chat-container');
                    
                    if (noChatSelected) noChatSelected.classList.add('hidden');
                    if (activeChatContainer) activeChatContainer.classList.remove('hidden');
                    
                    await this.loadMessages(chatId);
                    await this.markMessagesAsRead(chatId, this.currentUser.id);
                    
                    setTimeout(() => {
                        const messageInput = document.getElementById('message-input');
                        if (messageInput) messageInput.focus();
                    }, 100);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
                    const mobileTitle = document.getElementById('mobile-title');
                    if (mobileTitle) {
                        mobileTitle.textContent = user.firstname;
                    }
                    
                } catch (error) {
                    console.error('Error opening chat:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞', 'error');
                } finally {
                    this.isLoading = false;
                }
            }
            
            async loadMessages(chatId) {
                const container = document.getElementById('messages-container');
                if (!container) return;
                
                try {
                    container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px; color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p></div>';
                    
                    const messages = await this.getMessagesByChatId(chatId);
                    
                    if (messages.length === 0) {
                        container.innerHTML = `
                            <div class="no-content" style="padding: 40px 20px;">
                                <i class="fas fa-comment no-content-icon"></i>
                                <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    let lastDate = null;
                    
                    for (const msg of messages) {
                        try {
                            const isOutgoing = msg.sender_id === this.currentUser.id;
                            const sender = await this.getUserById(msg.sender_id);
                            const msgDate = new Date(msg.timestamp).toLocaleDateString();
                            
                            // –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç
                            if (msgDate !== lastDate) {
                                const dateStr = this.formatDate(msg.timestamp, true);
                                html += `
                                    <div class="message-date-divider">
                                        <span>${dateStr}</span>
                                    </div>
                                `;
                                lastDate = msgDate;
                            }
                            
                            html += `
                                <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}" data-message-id="${msg.id}" data-sender-id="${msg.sender_id}">
                                    ${!isOutgoing ? `
                                        <div class="emoji-avatar small" style="margin-right: 10px;">
                                            ${sender?.emoji || 'üë§'}
                                        </div>
                                    ` : ''}
                                    
                                    <div>
                                        <div class="message-bubble" data-message-id="${msg.id}">
                                            ${msg.content}
                                        </div>
                                        <div class="message-time">
                                            ${this.formatTime(msg.timestamp)}
                                            ${isOutgoing ? 
                                                `<span class="message-status">
                                                    ${msg.read ? '<i class="fas fa-check-double read"></i>' : '<i class="fas fa-check sent"></i>'}
                                                </span>` 
                                                : ''
                                            }
                                        </div>
                                    </div>
                                    
                                    ${isOutgoing ? `
                                        <div class="emoji-avatar small" style="margin-left: 10px;">
                                            ${this.currentUser.emoji || 'üë§'}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error processing message:', error);
                        }
                    }
                    
                    container.innerHTML = html;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                    container.querySelectorAll('.message-bubble').forEach(bubble => {
                        bubble.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.showMessageMenu(e.target.closest('.message'));
                        });
                    });
                    
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                    
                } catch (error) {
                    console.error('Error loading messages:', error);
                    container.innerHTML = `
                        <div class="no-content" style="padding: 40px 20px;">
                            <i class="fas fa-exclamation-triangle no-content-icon"></i>
                            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    `;
                }
            }
            
            // ========== –ú–ï–ù–Æ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô (–ö–ê–ö –í TELEGRAM) ==========
            
            showMessageMenu(messageElement) {
                const messageId = messageElement.dataset.messageId;
                const senderId = messageElement.dataset.senderId;
                const isOutgoing = senderId === this.currentUser.id;
                
                this.selectedMessageForAction = messageId;
                
                const messageMenu = document.getElementById('message-menu');
                if (!messageMenu) return;
                
                let menuItems = '';
                
                if (isOutgoing) {
                    // –î–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: –ø–µ—Ä–µ—Å–ª–∞—Ç—å, –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —É–¥–∞–ª–∏—Ç—å, –∑–∞–∫—Ä–µ–ø–∏—Ç—å
                    menuItems = `
                        <button class="message-menu-item" data-action="forward">
                            <div class="message-menu-item-icon"><i class="fas fa-share"></i></div>
                            <div>–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
                        </button>
                        <button class="message-menu-item" data-action="copy">
                            <div class="message-menu-item-icon"><i class="far fa-copy"></i></div>
                            <div>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                        </button>
                        <button class="message-menu-item" data-action="pin">
                            <div class="message-menu-item-icon"><i class="fas fa-thumbtack"></i></div>
                            <div>–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
                        </button>
                        <button class="message-menu-item delete" data-action="delete">
                            <div class="message-menu-item-icon"><i class="fas fa-trash"></i></div>
                            <div>–£–¥–∞–ª–∏—Ç—å</div>
                        </button>
                    `;
                } else {
                    // –î–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: –ø–µ—Ä–µ—Å–ª–∞—Ç—å, –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –∑–∞–∫—Ä–µ–ø–∏—Ç—å
                    menuItems = `
                        <button class="message-menu-item" data-action="forward">
                            <div class="message-menu-item-icon"><i class="fas fa-share"></i></div>
                            <div>–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
                        </button>
                        <button class="message-menu-item" data-action="copy">
                            <div class="message-menu-item-icon"><i class="far fa-copy"></i></div>
                            <div>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                        </button>
                        <button class="message-menu-item" data-action="pin">
                            <div class="message-menu-item-icon"><i class="fas fa-thumbtack"></i></div>
                            <div>–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
                        </button>
                    `;
                }
                
                messageMenu.innerHTML = menuItems;
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ä—è–¥–æ–º —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                const rect = messageElement.getBoundingClientRect();
                messageMenu.style.position = 'fixed';
                messageMenu.style.top = `${rect.top}px`;
                messageMenu.style.left = `${rect.left + rect.width}px`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–æ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                const menuRect = messageMenu.getBoundingClientRect();
                if (menuRect.right > window.innerWidth) {
                    messageMenu.style.left = `${rect.left - menuRect.width}px`;
                }
                
                messageMenu.classList.add('active');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
                messageMenu.querySelectorAll('.message-menu-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const action = item.dataset.action;
                        this.handleMessageAction(action, messageId);
                        messageMenu.classList.remove('active');
                    });
                });
            }
            
            async handleMessageAction(action, messageId) {
                try {
                    const message = await this.getMessageById(messageId);
                    if (!message) {
                        this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                        return;
                    }
                    
                    switch(action) {
                        case 'forward':
                            await this.forwardMessage(message);
                            break;
                        case 'copy':
                            await this.copyMessage(message);
                            break;
                        case 'delete':
                            await this.deleteMessageConfirmation(message);
                            break;
                        case 'pin':
                            await this.pinMessage(message);
                            break;
                    }
                } catch (error) {
                    console.error('Error handling message action:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è', 'error');
                }
            }
            
            async forwardMessage(message) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userChats = await this.getChatsByUserId(this.currentUser.id);
                    
                    let chatsHtml = '';
                    for (const chat of userChats) {
                        try {
                            const participants = JSON.parse(chat.participants || '[]');
                            const otherUserId = participants.find(id => id !== this.currentUser.id);
                            const otherUser = await this.getUserById(otherUserId);
                            
                            if (!otherUser) continue;
                            
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                            if (chat.id === this.currentChat?.id) continue;
                            
                            chatsHtml += `
                                <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer;"
                                     data-chat-id="${chat.id}">
                                    <div class="emoji-avatar small" style="margin-right: 10px;">
                                        ${otherUser.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${otherUser.firstname} ${otherUser.lastname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${otherUser.username}</div>
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error processing chat for forwarding:', error);
                        }
                    }
                    
                    if (!chatsHtml) {
                        this.showNotification('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —á–∞—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏', 'info');
                        return;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-color); border-radius: 8px;">
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">–°–æ–æ–±—â–µ–Ω–∏–µ:</div>
                                <div>${message.content}</div>
                            </div>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <h4 style="margin-bottom: 10px; color: var(--primary);">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç:</h4>
                                ${chatsHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-cancel').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
                    modal.querySelectorAll('[data-chat-id]').forEach(chatElement => {
                        chatElement.addEventListener('click', async () => {
                            const chatId = chatElement.dataset.chatId;
                            await this.forwardMessageToChat(message, chatId);
                            closeModal();
                        });
                    });
                    
                } catch (error) {
                    console.error('Error showing forward modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤', 'error');
                }
            }
            
            async forwardMessageToChat(message, targetChatId) {
                try {
                    await this.createMessage(targetChatId, this.currentUser.id, `–ü–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.content}`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
                    await this.updateChat(targetChatId, {
                        last_message: `–ü–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.content.substring(0, 100)}`,
                        last_message_time: new Date().toISOString()
                    });
                    
                    this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ', 'success');
                } catch (error) {
                    console.error('Error forwarding message:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            }
            
            async copyMessage(message) {
                try {
                    await navigator.clipboard.writeText(message.content);
                    this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                } catch (error) {
                    // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = message.content;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                }
            }
            
            async deleteMessageConfirmation(message) {
                const confirmed = await this.showConfirmationModal(
                    '–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?',
                    'warning'
                );
                
                if (confirmed) {
                    await this.deleteMessageAction(message);
                }
            }
            
            async deleteMessageAction(message) {
                try {
                    await this.deleteMessage(message.id);
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
                    if (this.currentChat && this.currentChat.id === message.chat_id) {
                        await this.loadMessages(this.currentChat.id);
                    }
                    
                    this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            }
            
            async pinMessage(message) {
                // –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
                this.showNotification('–§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
            }
            
            async sendMessage() {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                const now = Date.now();
                if (now - this.lastSendTime < 1000) { // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ - 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                    return;
                }
                
                if (this.isSendingMessage || !this.currentChat || !this.currentUser) {
                    return;
                }
                
                const input = document.getElementById('message-input');
                if (!input) return;
                
                const content = input.value.trim();
                
                if (!content) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
                    return;
                }
                
                this.isSendingMessage = true;
                this.lastSendTime = now;
                
                const sendButton = document.getElementById('send-button');
                if (sendButton) {
                    sendButton.disabled = true;
                    sendButton.innerHTML = '<div class="loader"></div>';
                }
                
                try {
                    // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                    await this.createMessage(this.currentChat.id, this.currentUser.id, content);
                    
                    await this.updateChat(this.currentChat.id, {
                        last_message: content.substring(0, 100),
                        last_message_time: new Date().toISOString()
                    });
                    
                    input.value = '';
                    this.adjustTextareaHeight(input);
                    await this.loadMessages(this.currentChat.id);
                    await this.loadChats();
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                } finally {
                    this.isSendingMessage = false;
                    const sendButton = document.getElementById('send-button');
                    if (sendButton) {
                        sendButton.disabled = false;
                        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    }
                }
            }
            
            async startChatWithUser(userId) {
                if (!this.currentUser || this.isLoading) return;
                
                try {
                    const isBlockedByMe = await this.isBlocked(this.currentUser.id, userId);
                    const isBlockedByOther = await this.isBlocked(userId, this.currentUser.id);
                    
                    if (isBlockedByMe || isBlockedByOther) {
                        this.showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —á–∞—Ç —Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'error');
                        return;
                    }
                    
                    const user = await this.getUserById(userId);
                    const userSettings = JSON.parse(user.settings || '{}');
                    
                    if (userSettings.messagePermissions === 'nobody') {
                        this.showNotification('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª –ø–∏—Å–∞—Ç—å –µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                        return;
                    }
                    
                    let chat = await this.getChatBetweenUsers(this.currentUser.id, userId);
                    
                    if (!chat) {
                        chat = await this.createChat([this.currentUser.id, userId], 'private');
                    }
                    
                    this.showScreen('chats');
                    setTimeout(() => {
                        this.openChat(chat.id, userId);
                    }, 100);
                    
                } catch (error) {
                    console.error('Error starting chat:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞', 'error');
                }
            }
            
            async deleteCurrentChat() {
                if (!this.currentChat) return;
                
                await this.deleteChatConfirmation(this.currentChat.id);
            }
            
            async deleteChatConfirmation(chatId) {
                const confirmed = await this.showConfirmationModal(
                    '–£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.',
                    'warning'
                );
                
                if (confirmed) {
                    await this.deleteChatAction(chatId);
                }
            }
            
            async deleteChatAction(chatId) {
                try {
                    await this.deleteChat(chatId);
                    
                    // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                    if (this.currentChat && this.currentChat.id === chatId) {
                        const activeChatContainer = document.getElementById('active-chat-container');
                        const noChatSelected = document.getElementById('no-chat-selected');
                        const backBtn = document.getElementById('back-to-chats-btn');
                        
                        if (activeChatContainer) activeChatContainer.classList.add('hidden');
                        if (noChatSelected) noChatSelected.classList.remove('hidden');
                        if (backBtn) backBtn.style.display = 'none';
                        this.currentChat = null;
                    }
                    
                    await this.loadChats();
                    this.showNotification(`–ß–∞—Ç —É–¥–∞–ª–µ–Ω`, 'info');
                    
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞', 'error');
                }
            }
            
            async deleteAllChatsConfirmation() {
                const confirmed = await this.showConfirmationModal(
                    '–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∞—Ç–æ–≤',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –≤–∞—à–∏ —á–∞—Ç—ã? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.',
                    'danger'
                );
                
                if (confirmed) {
                    await this.deleteAllChats();
                }
            }
            
            async deleteAllChats() {
                try {
                    const userChats = await this.getChatsByUserId(this.currentUser.id);
                    
                    for (const chat of userChats) {
                        await this.deleteChat(chat.id);
                    }
                    
                    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                    if (this.currentChat) {
                        const activeChatContainer = document.getElementById('active-chat-container');
                        const noChatSelected = document.getElementById('no-chat-selected');
                        const backBtn = document.getElementById('back-to-chats-btn');
                        
                        if (activeChatContainer) activeChatContainer.classList.add('hidden');
                        if (noChatSelected) noChatSelected.classList.remove('hidden');
                        if (backBtn) backBtn.style.display = 'none';
                        this.currentChat = null;
                    }
                    
                    await this.loadChats();
                    this.showNotification('–í—Å–µ —á–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã', 'info');
                    
                } catch (error) {
                    console.error('Error deleting all chats:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤', 'error');
                }
            }
            
            // ========== –°–ò–°–¢–ï–ú–ê –ü–û–°–¢–û–í ==========
            
            async renderPosts() {
                const container = document.getElementById('posts-container');
                if (!container) return;
                
                if (this.isLoading) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px; color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p></div>';
                    return;
                }
                
                this.isLoading = true;
                
                try {
                    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px; color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p></div>';
                    
                    const allPosts = await this.getAllPosts();
                    
                    if (allPosts.length === 0) {
                        container.innerHTML = `
                            <div class="no-content" style="padding: 60px 20px;">
                                <i class="fas fa-images no-content-icon"></i>
                                <h3>–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</h3>
                                <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ø–æ—Å—Ç!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    
                    for (const post of allPosts) {
                        try {
                            const author = await this.getUserById(post.author_id);
                            if (!author) continue;
                            
                            const reactions = await this.getReactionsByPostId(post.id);
                            const userReaction = await this.getReactionByUserAndPost(post.id, this.currentUser.id);
                            
                            const hashtags = JSON.parse(post.hashtags || '[]');
                            
                            html += `
                                <div class="post-card" data-post-id="${post.id}">
                                    <div class="post-header">
                                        <div class="post-author">
                                            <div class="emoji-avatar small">
                                                ${author.emoji || 'üë§'}
                                            </div>
                                            <div class="post-author-info">
                                                <div class="post-author-name">
                                                    ${author.firstname} ${author.lastname}
                                                    ${author.role === 'admin' ? '<span class="role-badge admin" style="margin-left: 5px;">ADMIN</span>' : ''}
                                                </div>
                                                <div class="post-author-username">
                                                    ${author.username}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="post-time">
                                            ${this.formatTime(post.timestamp)}
                                        </div>
                                    </div>
                                    
                                    <div class="post-content">
                                        ${post.content}
                                        ${hashtags.length > 0 ? `
                                            <div style="margin-top: 10px;">
                                                ${hashtags.map(tag => `<span style="color: var(--primary); margin-right: 5px;">${tag}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="post-stats">
                                        <span><i class="fas fa-heart"></i> ${reactions.filter(r => r.reaction_type === 'like').length} –ª–∞–π–∫–æ–≤</span>
                                        <span><i class="fas fa-thumbs-down"></i> ${reactions.filter(r => r.reaction_type === 'dislike').length} –¥–∏–∑–ª–∞–π–∫–æ–≤</span>
                                        <span><i class="fas fa-comment"></i> ${reactions.length} —Ä–µ–∞–∫—Ü–∏–π</span>
                                    </div>
                                    
                                    <div class="post-actions">
                                        <button class="post-action-btn ${userReaction?.reaction_type === 'like' ? 'liked' : ''}" 
                                                data-action="like" data-post-id="${post.id}">
                                            <i class="fas fa-heart"></i> –ù—Ä–∞–≤–∏—Ç—Å—è
                                        </button>
                                        <button class="post-action-btn ${userReaction?.reaction_type === 'dislike' ? 'disliked' : ''}" 
                                                data-action="dislike" data-post-id="${post.id}">
                                            <i class="fas fa-thumbs-down"></i> –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è
                                        </button>
                                        ${author.id === this.currentUser.id || this.currentUser.role === 'admin' ? `
                                            <button class="post-action-btn" data-action="delete-post" data-post-id="${post.id}">
                                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error rendering post:', error);
                        }
                    }
                    
                    container.innerHTML = html;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ—Å—Ç–æ–≤
                    container.addEventListener('click', (e) => {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        
                        const action = target.dataset.action;
                        const postId = target.dataset.postId;
                        
                        switch(action) {
                            case 'like':
                                this.reactToPost(postId, 'like');
                                break;
                            case 'dislike':
                                this.reactToPost(postId, 'dislike');
                                break;
                            case 'delete-post':
                                this.deletePostConfirmation(postId);
                                break;
                        }
                    });
                    
                } catch (error) {
                    console.error('Error rendering posts:', error);
                    container.innerHTML = `
                        <div class="no-content" style="padding: 60px 20px;">
                            <i class="fas fa-exclamation-triangle no-content-icon"></i>
                            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    `;
                } finally {
                    this.isLoading = false;
                }
            }
            
            async createPostModal() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                modal.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h2>
                        <button class="modal-close" id="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞</label>
                            <textarea class="form-input" id="post-content" 
                                      placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ? (–º–∞–∫—Å–∏–º—É–º 2000 —Å–∏–º–≤–æ–ª–æ–≤)" 
                                      rows="6" style="resize: vertical;"></textarea>
                            <div style="text-align: right; margin-top: 5px; font-size: 12px; color: var(--text-secondary);">
                                <span id="post-length">0</span>/2000 —Å–∏–º–≤–æ–ª–æ–≤
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–•–µ—à—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª)</label>
                            <input type="text" class="form-input" id="post-hashtags" placeholder="#–ø—Ä–∏–º–µ—Ä #—Ç–µ–≥ #–Ω–æ–≤–æ—Å—Ç–∏">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                –î–æ–±–∞–≤—å—Ç–µ –¥–æ 5 —Ö–µ—à—Ç–µ–≥–æ–≤
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" id="modal-create">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    </div>
                `;
                
                overlay.style.display = 'flex';
                
                const contentInput = modal.querySelector('#post-content');
                const lengthSpan = modal.querySelector('#post-length');
                
                if (contentInput && lengthSpan) {
                    contentInput.addEventListener('input', function() {
                        lengthSpan.textContent = this.value.length;
                    });
                }
                
                const closeModal = () => {
                    overlay.style.display = 'none';
                };
                
                modal.querySelector('#modal-close').addEventListener('click', closeModal);
                modal.querySelector('#modal-cancel').addEventListener('click', closeModal);
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal();
                    }
                });
                
                modal.querySelector('#modal-create').addEventListener('click', async () => {
                    const contentInput = modal.querySelector('#post-content');
                    const hashtagsInput = modal.querySelector('#post-hashtags');
                    
                    if (!contentInput || !hashtagsInput) return;
                    
                    const content = contentInput.value.trim();
                    const hashtagsInputValue = hashtagsInput.value.trim();
                    
                    if (!content) {
                        this.showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞', 'error');
                        return;
                    }
                    
                    if (content.length > 2000) {
                        this.showNotification('–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                        return;
                    }
                    
                    const hashtags = hashtagsInputValue
                        .split(' ')
                        .filter(tag => tag.startsWith('#') && tag.length > 1)
                        .slice(0, 5);
                    
                    try {
                        await this.createPost(this.currentUser.id, content, hashtags);
                        
                        closeModal();
                        await this.renderPosts();
                        this.showNotification('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!', 'success');
                        
                    } catch (error) {
                        this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞', 'error');
                    }
                });
            }
            
            async reactToPost(postId, reactionType) {
                try {
                    const existingReaction = await this.getReactionByUserAndPost(postId, this.currentUser.id);
                    
                    if (existingReaction) {
                        if (existingReaction.reaction_type === reactionType) {
                            await this.deleteReaction(existingReaction.id);
                        } else {
                            await this.createReaction(postId, this.currentUser.id, reactionType);
                        }
                    } else {
                        await this.createReaction(postId, this.currentUser.id, reactionType);
                    }
                    
                    await this.renderPosts();
                    
                } catch (error) {
                    console.error('Error reacting to post:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç', 'error');
                }
            }
            
            async deletePostConfirmation(postId) {
                try {
                    const post = await this.getPostById(postId);
                    if (!post) return;
                    
                    if (post.author_id !== this.currentUser.id && this.currentUser.role !== 'admin') {
                        this.showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç', 'error');
                        return;
                    }
                    
                    const author = await this.getUserById(post.author_id);
                    const isAdmin = this.currentUser.role === 'admin';
                    
                    if (!isAdmin && post.author_id !== this.currentUser.id) {
                        this.showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç', 'error');
                        return;
                    }
                    
                    const confirmed = await this.showConfirmationModal(
                        '–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞',
                        `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç${isAdmin ? ' (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)' : ''}?`,
                        'warning'
                    );
                    
                    if (confirmed) {
                        await this.deletePost(postId);
                        await this.renderPosts();
                        this.showNotification('–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω', 'info');
                    }
                    
                } catch (error) {
                    console.error('Error deleting post:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞', 'error');
                }
            }
            
            // ========== –ü–û–ò–°–ö ==========
            
            async renderSearchResults(query = '') {
                const container = document.getElementById('search-results');
                if (!container) return;
                
                if (this.isLoading) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px; color: var(--text-secondary);">–ü–æ–∏—Å–∫...</p></div>';
                    return;
                }
                
                this.isLoading = true;
                
                try {
                    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loader" style="margin: 0 auto;"></div><p style="margin-top: 10px; color: var(--text-secondary);">–ü–æ–∏—Å–∫...</p></div>';
                    
                    const allUsers = await this.getAllUsers();
                    let users = allUsers.filter(user => 
                        user.id !== this.currentUser.id && user.role !== 'admin' && !user.is_banned
                    );
                    
                    if (query.trim()) {
                        const searchLower = query.toLowerCase();
                        users = users.filter(user => 
                            user.firstname.toLowerCase().includes(searchLower) ||
                            user.lastname.toLowerCase().includes(searchLower) ||
                            user.username.toLowerCase().includes(searchLower) ||
                            (user.bio && user.bio.toLowerCase().includes(searchLower))
                        );
                    } else {
                        users = users.sort(() => Math.random() - 0.5).slice(0, 9);
                    }
                    
                    if (users.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                                <i class="fas fa-search no-content-icon"></i>
                                <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                        </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    
                    for (const user of users) {
                        try {
                            const isBlockedByMe = await this.isBlocked(this.currentUser.id, user.id);
                            const isBlockedByOther = await this.isBlocked(user.id, this.currentUser.id);
                            
                            const userSettings = user.settings ? JSON.parse(user.settings) : {};
                            const showStatus = userSettings.showStatus !== false;
                            const isOnline = user.status === 'online' && showStatus;
                            
                            html += `
                                <div class="user-card" data-user-id="${user.id}">
                                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                        <div class="emoji-avatar">
                                            ${user.emoji || 'üë§'}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 5px;">
                                                ${user.firstname} ${user.lastname}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                                <span class="username-badge">${user.username}</span>
                                                <span style="font-size: 12px; color: ${isOnline ? 'var(--success)' : 'var(--text-secondary)'}">
                                                    <i class="fas fa-circle" style="font-size: 8px;"></i> 
                                                    ${showStatus ? 
                                                        (isOnline ? '–û–Ω–ª–∞–π–Ω' : this.formatLastSeen(user.last_seen)) : 
                                                        '—Å–∫—Ä—ã—Ç'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">
                                        ${user.bio || '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-primary btn-sm" style="flex: 1;" 
                                                data-action="message" data-user-id="${user.id}"
                                                ${isBlockedByMe || isBlockedByOther ? 'disabled' : ''}>
                                            <i class="fas fa-comment"></i> –ù–∞–ø–∏—Å–∞—Ç—å
                                        </button>
                                        <button class="btn ${isBlockedByMe ? 'btn-success' : 'btn-danger'} btn-sm" 
                                                data-action="${isBlockedByMe ? 'unblock' : 'block'}" data-user-id="${user.id}">
                                            <i class="fas fa-${isBlockedByMe ? 'unlock' : 'ban'}"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error processing user for search:', error);
                        }
                    }
                    
                    container.innerHTML = html;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    container.addEventListener('click', (e) => {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        
                        const action = target.dataset.action;
                        const userId = target.dataset.userId;
                        
                        switch(action) {
                            case 'message':
                                this.startChatWithUser(userId);
                                break;
                            case 'block':
                            case 'unblock':
                                this.handleBlockAction(userId, action);
                                break;
                        }
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è
                    container.addEventListener('click', (e) => {
                        const userCard = e.target.closest('.user-card');
                        if (userCard && !e.target.closest('button')) {
                            const userId = userCard.dataset.userId;
                            this.showUserProfile(userId);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error rendering search results:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                            <i class="fas fa-exclamation-triangle no-content-icon"></i>
                            <h3>–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    `;
                } finally {
                    this.isLoading = false;
                }
            }
            
            async handleBlockAction(userId, action) {
                if (this.blockOperationInProgress) return;
                this.blockOperationInProgress = true;
                
                try {
                    if (action === 'block') {
                        await this.createBlock(this.currentUser.id, userId);
                        this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                    } else {
                        await this.deleteBlock(this.currentUser.id, userId);
                        this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
                    }
                    
                    const searchInput = document.getElementById('search-users-input');
                    await this.renderSearchResults(searchInput?.value || '');
                } catch (error) {
                    console.error('Error blocking/unblocking user:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
                } finally {
                    this.blockOperationInProgress = false;
                }
            }
            
            // ========== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ==========
            
            async renderAdminPanel() {
                await this.updateAdminStats();
                
                const container = document.getElementById('admin-content');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="settings-group">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π.
                        </p>
                        <p style="color: var(--text-secondary);">
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
                        </p>
                    </div>
                `;
            }
            
            async updateAdminStats() {
                try {
                    const users = await this.getAllUsers();
                    const posts = await this.getAllPosts();
                    
                    const totalUsers = users.length;
                    const onlineUsers = users.filter(u => 
                        u.status === 'online' && (u.settings ? JSON.parse(u.settings).showStatus !== false : true)
                    ).length;
                    const totalPosts = posts.length;
                    
                    let totalMessages = 0;
                    const allChats = await this.supabaseFetchWithSelect('chats', '*');
                    if (Array.isArray(allChats)) {
                        for (const chat of allChats) {
                            const messages = await this.getMessagesByChatId(chat.id);
                            totalMessages += messages.length;
                        }
                    }
                    
                    const adminTotalUsers = document.getElementById('admin-total-users');
                    const adminOnlineUsers = document.getElementById('admin-online-users');
                    const adminTotalPosts = document.getElementById('admin-total-posts');
                    const adminTotalMessages = document.getElementById('admin-total-messages');
                    
                    if (adminTotalUsers) adminTotalUsers.textContent = totalUsers;
                    if (adminOnlineUsers) adminOnlineUsers.textContent = onlineUsers;
                    if (adminTotalPosts) adminTotalPosts.textContent = totalPosts;
                    if (adminTotalMessages) adminTotalMessages.textContent = totalMessages;
                    
                } catch (error) {
                    console.error('Error updating admin stats:', error);
                }
            }
            
            // ========== –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
            
            async showUserProfile(userId) {
                try {
                    const user = await this.getUserById(userId);
                    if (!user) return;
                    
                    const modal = document.getElementById('modal');
                    const overlay = document.getElementById('modal-overlay');
                    
                    if (!modal || !overlay) return;
                    
                    const isBlockedByMe = await this.isBlocked(this.currentUser.id, userId);
                    const isBlockedByOther = await this.isBlocked(userId, this.currentUser.id);
                    const isCurrentUser = userId === this.currentUser.id;
                    
                    const userSettings = user.settings ? JSON.parse(user.settings) : {};
                    const showStatus = userSettings.showStatus !== false;
                    const isOnline = user.status === 'online' && showStatus;
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div class="emoji-avatar large" style="margin: 0 auto 15px auto;">
                                    ${user.emoji || 'üë§'}
                                </div>
                                <h3 style="margin-bottom: 5px;">${user.firstname} ${user.lastname}</h3>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                                    <span class="username-badge">${user.username}</span>
                                    ${user.role === 'admin' ? '<span class="role-badge admin">ADMIN</span>' : ''}
                                    ${user.is_private ? '<span style="color: var(--warning);">üîí</span>' : ''}
                                </div>
                                <div style="color: ${isOnline ? 'var(--success)' : 'var(--text-secondary)'}; margin-bottom: 10px;">
                                    <i class="fas fa-circle" style="font-size: 10px;"></i> 
                                    ${showStatus ? 
                                        (isOnline ? '–û–Ω–ª–∞–π–Ω' : this.formatLastSeen(user.last_seen)) : 
                                        '–°—Ç–∞—Ç—É—Å —Å–∫—Ä—ã—Ç'}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary);">–û —Å–µ–±–µ</h4>
                                <p style="color: var(--text-secondary); padding: 10px; background: var(--bg-color); border-radius: 8px;">
                                    ${user.bio || '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                                </p>
                            </div>
                            
                            ${isBlockedByMe || isBlockedByOther ? `
                                <div style="background: var(--danger); color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <i class="fas fa-ban"></i> ${isBlockedByMe ? '–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' : '–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤–∞—Å'}
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                            ${!isCurrentUser && !isBlockedByMe && !isBlockedByOther ? `
                                <button class="btn btn-primary" id="start-chat-profile-btn" data-user-id="${userId}">
                                    <i class="fas fa-comment"></i> –ù–∞–ø–∏—Å–∞—Ç—å
                                </button>
                            ` : ''}
                            ${!isCurrentUser ? `
                                <button class="btn ${isBlockedByMe ? 'btn-success' : 'btn-danger'}" id="block-profile-btn" data-user-id="${userId}">
                                    <i class="fas fa-${isBlockedByMe ? 'unlock' : 'ban'}"></i>
                                    ${isBlockedByMe ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                                </button>
                            ` : ''}
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    if (!isCurrentUser && !isBlockedByMe && !isBlockedByOther) {
                        modal.querySelector('#start-chat-profile-btn').addEventListener('click', () => {
                            closeModal();
                            this.startChatWithUser(userId);
                        });
                    }
                    
                    if (!isCurrentUser) {
                        modal.querySelector('#block-profile-btn').addEventListener('click', async () => {
                            if (this.blockOperationInProgress) return;
                            this.blockOperationInProgress = true;
                            
                            try {
                                if (isBlockedByMe) {
                                    await this.deleteBlock(this.currentUser.id, userId);
                                    this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
                                } else {
                                    await this.createBlock(this.currentUser.id, userId);
                                    this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                                }
                                
                                closeModal();
                                const searchInput = document.getElementById('search-users-input');
                                await this.renderSearchResults(searchInput?.value || '');
                            } catch (error) {
                                console.error('Error blocking/unblocking user:', error);
                                this.showNotification('–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
                            } finally {
                                this.blockOperationInProgress = false;
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('Error showing user profile:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                }
            }
            
            // ========== REAL-TIME –§–£–ù–ö–¶–ò–û–ù–ê–õ ==========
            
            setupRealtimeSubscriptions() {
                if (!this.currentUser) return;
                
                this.heartbeatInterval = setInterval(async () => {
                    if (this.currentUser) {
                        try {
                            await this.updateUserStatus(this.currentUser.id, 'online');
                        } catch (error) {
                            console.error('Error updating heartbeat:', error);
                        }
                    }
                }, 30000);
                
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.currentUser) {
                        this.updateUserStatus(this.currentUser.id, 'offline').catch(console.error);
                    } else if (this.currentUser) {
                        this.updateUserStatus(this.currentUser.id, 'online').catch(console.error);
                    }
                });
            }
            
            startMessagePolling() {
                if (this.messagePollingInterval) {
                    clearInterval(this.messagePollingInterval);
                }
                
                this.messagePollingInterval = setInterval(async () => {
                    if (this.currentUser && this.currentChat) {
                        await this.checkForNewMessages();
                    }
                    if (this.currentUser) {
                        await this.updateUnreadCounts();
                    }
                }, 2000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            }
            
            async checkForNewMessages() {
                try {
                    const newMessages = await this.getNewMessages(this.currentChat.id, this.lastMessageCheck);
                    
                    if (newMessages.length > 0) {
                        this.lastMessageCheck = Date.now();
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        for (const msg of newMessages) {
                            await this.addMessageToChat(msg);
                        }
                        
                        // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                        await this.markMessagesAsRead(this.currentChat.id, this.currentUser.id);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                        await this.loadChats();
                    }
                } catch (error) {
                    console.error('Error checking for new messages:', error);
                }
            }
            
            async addMessageToChat(message) {
                const container = document.getElementById('messages-container');
                if (!container) return;
                
                try {
                    const isOutgoing = message.sender_id === this.currentUser.id;
                    const sender = await this.getUserById(message.sender_id);
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
                    messageElement.setAttribute('data-message-id', message.id);
                    messageElement.setAttribute('data-sender-id', message.sender_id);
                    messageElement.innerHTML = `
                        ${!isOutgoing ? `
                            <div class="emoji-avatar small" style="margin-right: 10px;">
                                ${sender?.emoji || 'üë§'}
                            </div>
                        ` : ''}
                        
                        <div>
                            <div class="message-bubble" data-message-id="${message.id}">
                                ${message.content}
                            </div>
                            <div class="message-time">
                                ${this.formatTime(message.timestamp)}
                                ${isOutgoing ? 
                                    `<span class="message-status">
                                        ${message.read ? '<i class="fas fa-check-double read"></i>' : '<i class="fas fa-check sent"></i>'}
                                    </span>` 
                                    : ''
                                }
                            </div>
                        </div>
                        
                        ${isOutgoing ? `
                            <div class="emoji-avatar small" style="margin-left: 10px;">
                                ${this.currentUser.emoji || 'üë§'}
                            </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(messageElement);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const bubble = messageElement.querySelector('.message-bubble');
                    if (bubble) {
                        bubble.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.showMessageMenu(messageElement);
                        });
                    }
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                    
                } catch (error) {
                    console.error('Error adding message to chat:', error);
                }
            }
            
            async updateUnreadCounts() {
                try {
                    const userChats = await this.getChatsByUserId(this.currentUser.id);
                    
                    for (const chat of userChats) {
                        const messages = await this.getMessagesByChatId(chat.id);
                        const unreadCount = messages.filter(m => 
                            m.sender_id !== this.currentUser.id && !m.read
                        ).length;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                        const chatItem = document.querySelector(`.chat-item[data-chat-id="${chat.id}"]`);
                        if (chatItem) {
                            const unreadBadge = chatItem.querySelector('.unread-badge');
                            if (unreadCount > 0) {
                                chatItem.classList.add('unread');
                                if (!unreadBadge) {
                                    const meta = chatItem.querySelector('.chat-meta');
                                    if (meta) {
                                        meta.innerHTML = `
                                            <div>${this.formatTime(chat.last_message_time)}</div>
                                            <div class="unread-badge">${unreadCount}</div>
                                        `;
                                    }
                                } else {
                                    unreadBadge.textContent = unreadCount;
                                }
                            } else {
                                chatItem.classList.remove('unread');
                                if (unreadBadge) {
                                    unreadBadge.remove();
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating unread counts:', error);
                }
            }
            
            // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
            
            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)} —á –Ω–∞–∑–∞–¥`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
                
                return date.toLocaleDateString();
            }
            
            formatDate(timestamp, withRelative = false) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (withRelative) {
                    if (diff < 86400000) return '–°–µ–≥–æ–¥–Ω—è';
                    if (diff < 172800000) return '–í—á–µ—Ä–∞';
                    if (diff < 604800000) {
                        const days = Math.floor(diff / 86400000);
                        return `${days} –¥–Ω—è –Ω–∞–∑–∞–¥`;
                    }
                }
                
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: diff < 31536000000 ? undefined : 'numeric'
                });
            }
            
            formatLastSeen(timestamp) {
                if (!timestamp) return '–¥–∞–≤–Ω–æ';
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                if (diff < 300000) return '–±—ã–ª(–∞) 1 –º–∏–Ω—É—Ç—É –Ω–∞–∑–∞–¥';
                if (diff < 3600000) return `–±—ã–ª(–∞) ${Math.floor(diff / 60000)} –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥`;
                if (diff < 7200000) return '–±—ã–ª(–∞) 1 —á–∞—Å –Ω–∞–∑–∞–¥';
                if (diff < 86400000) return `–±—ã–ª(–∞) ${Math.floor(diff / 3600000)} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥`;
                if (diff < 172800000) return '–±—ã–ª(–∞) –≤—á–µ—Ä–∞';
                
                return `–±—ã–ª(–∞) ${date.toLocaleDateString()}`;
            }
            
            adjustTextareaHeight(textarea) {
                if (!textarea) return;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            showNotification(message, type = 'info') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                if (type === 'system' && !this.notificationSettings.system) return;
                if (type === 'success' && !this.notificationSettings.system) return;
                if (type === 'error' && !this.notificationSettings.system) return;
                if (type === 'warning' && !this.notificationSettings.system) return;
                
                // –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã
                if (!this.notificationSettings.site) return;
                
                const container = document.getElementById('notification-container');
                if (!container) return;
                
                const id = 'notification-' + Date.now();
                
                let icon = 'fas fa-info-circle';
                if (type === 'success') icon = 'fas fa-check-circle';
                if (type === 'warning') icon = 'fas fa-exclamation-triangle';
                if (type === 'error') icon = 'fas fa-times-circle';
                
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.id = id;
                notification.innerHTML = `
                    <i class="${icon} notification-icon" style="color: ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'}"></i>
                    <div class="notification-content">
                        <div class="notification-title">RedMessenger PRO</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">&times;</button>
                `;
                
                container.appendChild(notification);
                
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });
                
                setTimeout(() => {
                    const element = document.getElementById(id);
                    if (element) element.remove();
                }, 5000);
            }
            
            async showConfirmationModal(title, message, type = 'warning') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal');
                    const overlay = document.getElementById('modal-overlay');
                    
                    if (!modal || !overlay) {
                        resolve(false);
                        return;
                    }
                    
                    let icon = 'fas fa-exclamation-triangle';
                    let btnColor = 'btn-warning';
                    
                    if (type === 'danger') {
                        icon = 'fas fa-skull-crossbones';
                        btnColor = 'btn-danger';
                    } else if (type === 'info') {
                        icon = 'fas fa-info-circle';
                        btnColor = 'btn-primary';
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; padding: 20px;">
                                <i class="${icon}" style="font-size: 60px; color: ${type === 'danger' ? 'var(--danger)' : type === 'warning' ? 'var(--warning)' : 'var(--primary)'}; margin-bottom: 20px;"></i>
                                <p style="font-size: 16px; line-height: 1.5;">${message}</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                            <button class="btn ${btnColor}" id="modal-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = (result) => {
                        overlay.style.display = 'none';
                        resolve(result);
                    };
                    
                    modal.querySelector('#modal-close').addEventListener('click', () => closeModal(false));
                    modal.querySelector('#modal-cancel').addEventListener('click', () => closeModal(false));
                    modal.querySelector('#modal-confirm').addEventListener('click', () => closeModal(true));
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal(false);
                    });
                });
            }
            
            // ========== –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò ==========
            
            async showAllUsersAdmin() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const users = await this.getAllUsers();
                    
                    let usersHtml = '';
                    for (const user of users) {
                        const isCurrentUser = user.id === this.currentUser?.id;
                        const userSettings = user.settings ? JSON.parse(user.settings) : {};
                        const isOnline = user.status === 'online' && userSettings.showStatus !== false;
                        
                        usersHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="emoji-avatar small">
                                        ${user.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">
                                            ${user.firstname} ${user.lastname}
                                            ${user.role === 'admin' ? ' <span class="role-badge admin" style="font-size: 9px;">ADMIN</span>' : ''}
                                            ${user.is_private ? ' <span style="color: var(--warning); font-size: 9px;">üîí</span>' : ''}
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            ${user.username}
                                            ‚Ä¢ ${isOnline ? '<span style="color: var(--success);">–û–Ω–ª–∞–π–Ω</span>' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${!isCurrentUser ? `
                                        <button class="btn btn-danger btn-sm" data-action="delete-user-admin" data-user-id="${user.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button class="btn btn-${user.role === 'admin' ? 'danger' : 'success'} btn-sm" 
                                                data-action="${user.role === 'admin' ? 'remove-admin' : 'make-admin'}" 
                                                data-user-id="${user.id}">
                                            <i class="fas fa-user-shield"></i>
                                        </button>
                                        ${user.is_banned ? `
                                            <button class="btn btn-success btn-sm" data-action="unban-user" data-user-id="${user.id}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : `
                                            <button class="btn btn-warning btn-sm" data-action="ban-user" data-user-id="${user.id}">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        `}
                                    ` : '<span style="padding: 4px 8px; background: var(--primary); color: white; border-radius: 4px;">–í–´</span>'}
                                </div>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (${users.length})</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${usersHtml || '<p style="color: var(--text-secondary); text-align: center;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        
                        const action = target.dataset.action;
                        const userId = target.dataset.userId;
                        
                        switch(action) {
                            case 'delete-user-admin':
                                await this.deleteUserAdminConfirmation(userId);
                                break;
                            case 'make-admin':
                                await this.makeUserAdmin(userId);
                                closeModal();
                                break;
                            case 'remove-admin':
                                await this.removeUserAdmin(userId);
                                closeModal();
                                break;
                            case 'ban-user':
                                await this.banUserAdmin(userId);
                                closeModal();
                                break;
                            case 'unban-user':
                                await this.unbanUserAdmin(userId);
                                closeModal();
                                break;
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing all users admin:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                }
            }
            
            async deleteUserAdminConfirmation(userId) {
                const user = await this.getUserById(userId);
                if (!user) return;
                
                const confirmed = await this.showConfirmationModal(
                    '–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.username}? –í—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`,
                    'danger'
                );
                
                if (confirmed) {
                    await this.deleteUserAdmin(userId);
                    this.showAllUsersAdmin();
                }
            }
            
            async deleteUserAdmin(userId) {
                try {
                    const user = await this.getUserById(userId);
                    if (!user) return;
                    
                    if (user.role === 'admin' && this.currentUser.id !== '00000000-0000-0000-0000-000000000001') {
                        this.showNotification('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω–æ–≤', 'error');
                        return;
                    }
                    
                    await this.deleteUser(userId);
                    this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω', 'success');
                    await this.renderAdminPanel();
                    await this.loadChats();
                    
                } catch (error) {
                    console.error('Error deleting user admin:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            }
            
            async makeUserAdmin(userId) {
                try {
                    await this.updateUser(userId, { role: 'admin' });
                    this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'success');
                } catch (error) {
                    console.error('Error making user admin:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
                }
            }
            
            async removeUserAdmin(userId) {
                try {
                    if (userId === '00000000-0000-0000-0000-000000000001') {
                        this.showNotification('–ù–µ–ª—å–∑—è —Å–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
                        return;
                    }
                    
                    await this.updateUser(userId, { role: 'user' });
                    this.showNotification('–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–Ω—è—Ç—ã', 'info');
                } catch (error) {
                    console.error('Error removing admin:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
                }
            }
            
            async banUserAdmin(userId) {
                try {
                    await this.updateUser(userId, { is_banned: true });
                    this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                } catch (error) {
                    console.error('Error banning user:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            }
            
            async unbanUserAdmin(userId) {
                try {
                    await this.updateUser(userId, { is_banned: false });
                    this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
                } catch (error) {
                    console.error('Error unbanning user:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            }
            
            async banUserAdminModal() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const users = await this.getAllUsers();
                    const normalUsers = users.filter(u => u.role !== 'admin' && !u.is_banned);
                    
                    if (normalUsers.length === 0) {
                        this.showNotification('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'info');
                        return;
                    }
                    
                    let usersHtml = '';
                    for (const user of normalUsers) {
                        usersHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="emoji-avatar small">
                                        ${user.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div>${user.firstname} ${user.lastname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${user.username}</div>
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-sm" data-action="ban-selected-user" data-user-id="${user.id}">
                                    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${usersHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="ban-selected-user"]');
                        if (target) {
                            const userId = target.dataset.userId;
                            await this.banUserAdmin(userId);
                            closeModal();
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing ban modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                }
            }
            
            async unbanUserAdminModal() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const users = await this.getAllUsers();
                    const bannedUsers = users.filter(u => u.is_banned);
                    
                    if (bannedUsers.length === 0) {
                        this.showNotification('–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'info');
                        return;
                    }
                    
                    let usersHtml = '';
                    for (const user of bannedUsers) {
                        usersHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="emoji-avatar small">
                                        ${user.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div>${user.firstname} ${user.lastname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${user.username}</div>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" data-action="unban-selected-user" data-user-id="${user.id}">
                                    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${usersHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="unban-selected-user"]');
                        if (target) {
                            const userId = target.dataset.userId;
                            await this.unbanUserAdmin(userId);
                            closeModal();
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing unban modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                }
            }
            
            async grantAdminModal() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const users = await this.getAllUsers();
                    const normalUsers = users.filter(u => u.role !== 'admin' && u.id !== this.currentUser.id);
                    
                    if (normalUsers.length === 0) {
                        this.showNotification('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'info');
                        return;
                    }
                    
                    let usersHtml = '';
                    for (const user of normalUsers) {
                        usersHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="emoji-avatar small">
                                        ${user.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div>${user.firstname} ${user.lastname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${user.username}</div>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" data-action="grant-admin-selected" data-user-id="${user.id}">
                                    –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                </button>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${usersHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="grant-admin-selected"]');
                        if (target) {
                            const userId = target.dataset.userId;
                            await this.makeUserAdmin(userId);
                            closeModal();
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing grant admin modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                }
            }
            
            async revokeAdminModal() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const users = await this.getAllUsers();
                    const adminUsers = users.filter(u => u.role === 'admin' && u.id !== this.currentUser.id && u.id !== '00000000-0000-0000-0000-000000000001');
                    
                    if (adminUsers.length === 0) {
                        this.showNotification('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤', 'info');
                        return;
                    }
                    
                    let usersHtml = '';
                    for (const user of adminUsers) {
                        usersHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="emoji-avatar small">
                                        ${user.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div>${user.firstname} ${user.lastname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${user.username}</div>
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-sm" data-action="revoke-admin-selected" data-user-id="${user.id}">
                                    –°–Ω—è—Ç—å –ø—Ä–∞–≤–∞
                                </button>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–°–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${usersHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="revoke-admin-selected"]');
                        if (target) {
                            const userId = target.dataset.userId;
                            await this.removeUserAdmin(userId);
                            closeModal();
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing revoke admin modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                }
            }
            
            async editUserAdmin() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const users = await this.getAllUsers();
                    
                    let usersHtml = '';
                    for (const user of users) {
                        usersHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="emoji-avatar small">
                                        ${user.emoji || 'üë§'}
                                    </div>
                                    <div>
                                        <div>${user.firstname} ${user.lastname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${user.username}</div>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm" data-action="edit-selected-user" data-user-id="${user.id}">
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${usersHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="edit-selected-user"]');
                        if (target) {
                            const userId = target.dataset.userId;
                            closeModal();
                            await this.editUserDetailsAdmin(userId);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing edit users modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                }
            }
            
            async editUserDetailsAdmin(userId) {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const user = await this.getUserById(userId);
                    if (!user) return;
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${user.username}</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">–ò–º—è</label>
                                <input type="text" class="form-input" id="edit-admin-firstname" value="${user.firstname || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                                <input type="text" class="form-input" id="edit-admin-lastname" value="${user.lastname || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                                <input type="text" class="form-input" id="edit-admin-username" value="${user.username || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–≠–º–æ–¥–∑–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
                                <input type="text" class="form-input" id="edit-admin-emoji" value="${user.emoji || 'üë§'}" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                                <textarea class="form-input" id="edit-admin-bio" rows="3">${user.bio || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–†–æ–ª—å</label>
                                <select class="form-input" id="edit-admin-role">
                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="edit-admin-banned" ${user.is_banned ? 'checked' : ''}>
                                    <span>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="edit-admin-private" ${user.is_private ? 'checked' : ''}>
                                    <span>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                            <button class="btn btn-primary" id="modal-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-cancel').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.querySelector('#modal-save').addEventListener('click', async () => {
                        const firstname = modal.querySelector('#edit-admin-firstname').value.trim();
                        const lastname = modal.querySelector('#edit-admin-lastname').value.trim();
                        const username = modal.querySelector('#edit-admin-username').value.trim();
                        const emoji = modal.querySelector('#edit-admin-emoji').value.trim();
                        const bio = modal.querySelector('#edit-admin-bio').value.trim();
                        const role = modal.querySelector('#edit-admin-role').value;
                        const isBanned = modal.querySelector('#edit-admin-banned').checked;
                        const isPrivate = modal.querySelector('#edit-admin-private').checked;
                        
                        if (!firstname || !lastname || !username) {
                            this.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                            return;
                        }
                        
                        try {
                            await this.updateUser(userId, {
                                firstname,
                                lastname,
                                username,
                                emoji,
                                bio,
                                role,
                                is_banned: isBanned,
                                is_private: isPrivate
                            });
                            
                            closeModal();
                            this.showNotification('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                            await this.renderAdminPanel();
                            
                        } catch (error) {
                            console.error('Error updating user:', error);
                            this.showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing edit user details:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            }
            
            async createUserAdmin() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                modal.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                        <button class="modal-close" id="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">–ò–º—è</label>
                            <input type="text" class="form-input" id="new-user-firstname" placeholder="–ò–º—è">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                            <input type="text" class="form-input" id="new-user-lastname" placeholder="–§–∞–º–∏–ª–∏—è">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="color: var(--text-secondary);">@</span>
                                <input type="text" class="form-input" id="new-user-username" placeholder="username">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <input type="text" class="form-input" id="new-user-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–≠–º–æ–¥–∑–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
                            <input type="text" class="form-input" id="new-user-emoji" value="üë§" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                            <textarea class="form-input" id="new-user-bio" placeholder="–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="new-user-admin">
                                <span>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" id="modal-create">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                `;
                
                overlay.style.display = 'flex';
                
                const closeModal = () => {
                    overlay.style.display = 'none';
                };
                
                modal.querySelector('#modal-close').addEventListener('click', closeModal);
                modal.querySelector('#modal-cancel').addEventListener('click', closeModal);
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal();
                    }
                });
                
                modal.querySelector('#modal-create').addEventListener('click', async () => {
                    const firstname = modal.querySelector('#new-user-firstname')?.value.trim() || '';
                    const lastname = modal.querySelector('#new-user-lastname')?.value.trim() || '';
                    const usernameInput = modal.querySelector('#new-user-username')?.value.trim() || '';
                    const username = '@' + usernameInput;
                    const password = modal.querySelector('#new-user-password')?.value.trim() || '';
                    const emoji = modal.querySelector('#new-user-emoji')?.value.trim() || 'üë§';
                    const bio = modal.querySelector('#new-user-bio')?.value.trim() || '';
                    const admin = modal.querySelector('#new-user-admin')?.checked || false;
                    
                    if (!firstname || !lastname || !usernameInput || !password) {
                        this.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                        return;
                    }
                    
                    if (!/^@[a-zA-Z0-9_]+$/.test(username)) {
                        this.showNotification('–Æ–∑–µ—Ä–Ω–µ–π–º –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        this.showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                        return;
                    }
                    
                    try {
                        const existingUser = await this.getUserByUsername(username);
                        if (existingUser) {
                            this.showNotification('–≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç', 'error');
                            return;
                        }
                        
                        const newUser = {
                            id: this.generateUUID(),
                            firstname: firstname,
                            lastname: lastname,
                            username: username,
                            password: password,
                            emoji: emoji,
                            bio: bio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
                            status: 'online',
                            role: admin ? 'admin' : 'user',
                            is_private: false,
                            is_banned: false,
                            settings: JSON.stringify({
                                privateProfile: false,
                                showStatus: true,
                                darkTheme: true,
                                compactMode: false,
                                sound: true,
                                messageNotifications: true,
                                postNotifications: false,
                                messagePermissions: 'all',
                                fontSize: 14,
                                density: 3,
                                opacity: 100,
                                volume: 50,
                                theme: 'dark',
                                notifications: {
                                    site: true,
                                    messages: true,
                                    posts: false,
                                    system: true,
                                    sound: true,
                                    volume: 50
                                }
                            }),
                            last_seen: new Date().toISOString()
                        };
                        
                        await this.createUser(newUser);
                        
                        closeModal();
                        this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω', 'success');
                        await this.renderAdminPanel();
                        
                    } catch (error) {
                        this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    }
                });
            }
            
            async editPostAdmin() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const posts = await this.getAllPosts();
                    
                    let postsHtml = '';
                    for (const post of posts) {
                        const author = await this.getUserById(post.author_id);
                        postsHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${author?.firstname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${author?.lastname || ''}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">${post.content.substring(0, 50)}${post.content.length > 50 ? '...' : ''}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">${this.formatTime(post.timestamp)}</div>
                                </div>
                                <button class="btn btn-primary btn-sm" data-action="edit-selected-post" data-post-id="${post.id}">
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        `;
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${postsHtml || '<p style="color: var(--text-secondary); text-align: center;">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="edit-selected-post"]');
                        if (target) {
                            const postId = target.dataset.postId;
                            closeModal();
                            await this.editPostDetailsAdmin(postId);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing edit posts modal:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤', 'error');
                }
            }
            
            async editPostDetailsAdmin(postId) {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const post = await this.getPostById(postId);
                    if (!post) return;
                    
                    const author = await this.getUserById(post.author_id);
                    const hashtags = JSON.parse(post.hashtags || '[]').join(' ');
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">–ê–≤—Ç–æ—Ä</label>
                                <div style="padding: 10px; background: var(--bg-color); border-radius: 5px;">
                                    ${author?.firstname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ${author?.lastname || ''} (${author?.username || '@unknown'})
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                                <textarea class="form-input" id="edit-post-content" rows="6">${post.content || ''}</textarea>
                                <div style="text-align: right; margin-top: 5px; font-size: 12px; color: var(--text-secondary);">
                                    <span id="edit-post-length">${post.content?.length || 0}</span>/2000 —Å–∏–º–≤–æ–ª–æ–≤
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–•–µ—à—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª)</label>
                                <input type="text" class="form-input" id="edit-post-hashtags" value="${hashtags}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                            <button class="btn btn-primary" id="modal-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="btn btn-danger" id="modal-delete" data-post-id="${postId}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const contentInput = modal.querySelector('#edit-post-content');
                    const lengthSpan = modal.querySelector('#edit-post-length');
                    
                    if (contentInput && lengthSpan) {
                        contentInput.addEventListener('input', function() {
                            lengthSpan.textContent = this.value.length;
                        });
                    }
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-cancel').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    modal.querySelector('#modal-save').addEventListener('click', async () => {
                        const content = modal.querySelector('#edit-post-content').value.trim();
                        const hashtagsInput = modal.querySelector('#edit-post-hashtags').value.trim();
                        
                        if (!content) {
                            this.showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞', 'error');
                            return;
                        }
                        
                        if (content.length > 2000) {
                            this.showNotification('–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                            return;
                        }
                        
                        const hashtags = hashtagsInput
                            .split(' ')
                            .filter(tag => tag.startsWith('#') && tag.length > 1)
                            .slice(0, 5);
                        
                        try {
                            await this.updatePost(postId, {
                                content,
                                hashtags: JSON.stringify(hashtags)
                            });
                            
                            closeModal();
                            this.showNotification('–ü–æ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                            await this.renderPosts();
                            await this.renderAdminPanel();
                            
                        } catch (error) {
                            console.error('Error updating post:', error);
                            this.showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞', 'error');
                        }
                    });
                    
                    modal.querySelector('#modal-delete').addEventListener('click', async () => {
                        const confirmed = await this.showConfirmationModal(
                            '–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞',
                            '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?',
                            'warning'
                        );
                        
                        if (confirmed) {
                            try {
                                await this.deletePost(postId);
                                closeModal();
                                this.showNotification('–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω', 'info');
                                await this.renderPosts();
                                await this.renderAdminPanel();
                            } catch (error) {
                                console.error('Error deleting post:', error);
                                this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞', 'error');
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing edit post details:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞', 'error');
                }
            }
            
            async showAllPostsAdmin() {
                const modal = document.getElementById('modal');
                const overlay = document.getElementById('modal-overlay');
                
                if (!modal || !overlay) return;
                
                try {
                    const posts = await this.getAllPosts();
                    
                    let postsHtml = '';
                    for (const post of posts) {
                        try {
                            const author = await this.getUserById(post.author_id);
                            const reactions = await this.getReactionsByPostId(post.id);
                            
                            postsHtml += `
                                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-color); border-radius: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div class="emoji-avatar small">
                                                ${author?.emoji || 'üë§'}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${author?.firstname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${author?.lastname || ''}</div>
                                                <div style="font-size: 13px; color: var(--text-secondary);">${author?.username || '@unknown'}</div>
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${this.formatTime(post.timestamp)}
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 10px; padding: 10px; background: var(--card-bg); border-radius: 5px;">
                                        ${post.content.substring(0, 200)}${post.content.length > 200 ? '...' : ''}
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            üëç ${reactions.filter(r => r.reaction_type === 'like').length} ‚Ä¢ üëé ${reactions.filter(r => r.reaction_type === 'dislike').length}
                                        </div>
                                        <button class="btn btn-danger btn-sm" data-action="delete-post-admin" data-post-id="${post.id}">
                                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å—Ç–∞:', post.id, error);
                        }
                    }
                    
                    modal.innerHTML = `
                        <div class="modal-header">
                            <h2 class="modal-title">–í—Å–µ –ø–æ—Å—Ç—ã (${posts.length})</h2>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${postsHtml || '<p style="color: var(--text-secondary); text-align: center;">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    
                    overlay.style.display = 'flex';
                    
                    const closeModal = () => overlay.style.display = 'none';
                    modal.querySelector('#modal-close').addEventListener('click', closeModal);
                    modal.querySelector('#modal-close-btn').addEventListener('click', closeModal);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            closeModal();
                        }
                    });
                    
                    modal.addEventListener('click', async (e) => {
                        const target = e.target.closest('[data-action="delete-post-admin"]');
                        if (target) {
                            const postId = target.dataset.postId;
                            await this.deletePostConfirmation(postId);
                            closeModal();
                        }
                    });
                    
                } catch (error) {
                    console.error('Error showing all posts admin:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤', 'error');
                }
            }
            
            async backupData() {
                try {
                    const data = {
                        users: await this.getAllUsers(),
                        posts: await this.getAllPosts(),
                        chats: await this.supabaseFetchWithSelect('chats', '*'),
                        messages: await this.supabaseFetchWithSelect('messages', '*'),
                        blockedUsers: await this.supabaseFetchWithSelect('blocked_users', '*'),
                        postReactions: await this.supabaseFetchWithSelect('post_reactions', '*'),
                        backupDate: new Date().toISOString(),
                        backupType: 'full'
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const backupFileName = `redmessenger_backup_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', backupFileName);
                    linkElement.click();
                    
                    this.showNotification('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'success');
                    
                } catch (error) {
                    console.error('Error creating backup:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'error');
                }
            }
            
            async exportData() {
                try {
                    const data = {
                        users: await this.getAllUsers(),
                        posts: await this.getAllPosts(),
                        chats: await this.supabaseFetchWithSelect('chats', '*'),
                        messages: await this.supabaseFetchWithSelect('messages', '*'),
                        blockedUsers: await this.supabaseFetchWithSelect('blocked_users', '*'),
                        postReactions: await this.supabaseFetchWithSelect('post_reactions', '*'),
                        exportedAt: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileName = `redmessenger_export_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileName);
                    linkElement.click();
                    
                    this.showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                    
                } catch (error) {
                    console.error('Error exporting data:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
            }
            
            async clearAllPostsConfirmation() {
                const confirmed = await this.showConfirmationModal(
                    '–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –ø–æ—Å—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
                    'danger'
                );
                
                if (confirmed) {
                    await this.clearAllPosts();
                }
            }
            
            async clearAllPosts() {
                try {
                    const allPosts = await this.getAllPosts();
                    
                    for (const post of allPosts) {
                        await this.deletePost(post.id);
                    }
                    
                    await this.renderPosts();
                    await this.renderAdminPanel();
                    this.showNotification('–í—Å–µ –ø–æ—Å—Ç—ã —É–¥–∞–ª–µ–Ω—ã', 'info');
                    
                } catch (error) {
                    console.error('Error clearing all posts:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤', 'error');
                }
            }
            
            async clearAllDataConfirmation() {
                const confirmed = await this.showConfirmationModal(
                    '–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!',
                    'danger'
                );
                
                if (confirmed) {
                    const confirmed2 = await this.showConfirmationModal(
                        '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏',
                        '–í—ã —É–≤–µ—Ä–µ–Ω—ã –Ω–∞ 100%? –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —á–∞—Ç—ã, —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ—Å—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.',
                        'danger'
                    );
                    
                    if (confirmed2) {
                        await this.clearAllData();
                    }
                }
            }
            
            async clearAllData() {
                try {
                    const allUsers = await this.getAllUsers();
                    
                    for (const user of allUsers) {
                        if (user.id !== this.currentUser.id) {
                            await this.deleteUser(user.id);
                        }
                    }
                    
                    const allChats = await this.supabaseFetchWithSelect('chats', '*');
                    
                    if (Array.isArray(allChats)) {
                        for (const chat of allChats) {
                            await this.deleteChat(chat.id);
                        }
                    }
                    
                    const allPosts = await this.getAllPosts();
                    
                    for (const post of allPosts) {
                        await this.deletePost(post.id);
                    }
                    
                    this.logout();
                    this.showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —É–¥–∞–ª–µ–Ω—ã', 'warning');
                    
                } catch (error) {
                    console.error('Error clearing all data:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.messenger = new RedMessengerPRO();
                window.messenger.init();
                
                window.addEventListener('beforeunload', async () => {
                    if (window.messenger && window.messenger.currentUser) {
                        try {
                            await window.messenger.updateUserStatus(window.messenger.currentUser.id, 'offline');
                        } catch (error) {
                            console.error('Error updating status on page unload:', error);
                        }
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            }
        });
    </script>
</body>
</html>